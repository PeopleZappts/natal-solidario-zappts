<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natal Solid√°rio Zappts 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        .star {
            animation: twinkle 3s infinite;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>

class NatalSolidario {

    supabaseUrl = "https://qykyaafhqaatlefozrvq.supabase.co/data/v1";
    supabaseKey = "sb_publishable_R-N-XCpFVnUlf-5Z16VLjg_xaxCeNGp";

    async request(path, options = {}) {
        options.headers = {
            "apikey": this.supabaseKey,
            "Authorization": `Bearer ${this.supabaseKey}`,
            "Content-Type": "application/json",
            ...options.headers
        };

        const res = await fetch(`${this.supabaseUrl}${path}`, options);
        if (!res.ok) {
            console.error("ERRO SUPABASE:", await res.text());
            throw new Error("Falha ao conectar ao Supabase");
        }
        return res.json();
    }

    constructor() {
        this.cartas = [];
        this.senhaRelatorio = '@People123';
        this.carregarCartas();
    }

    /* ============================
        CARREGAR CARTAS DO BANCO
    ============================ */
    async carregarCartas() {
        try {
            const dados = await this.request(`/tables/cartas?select=*`);
            this.cartas = dados.map(row => ({
                id: row.id,
                nome: row.nome,
                idade: row.idade,
                desejo: row.desejo,
                imagem: row.imagem,
                escolhidosPor: row.escolhidos_por || []
            }));
        } catch (err) {
            console.error("Erro ao carregar cartas:", err);
            this.cartas = [];
        }

        this.renderizar();
    }

    /* ============================
        ADICIONAR NOVA CARTA
    ============================ */
    async adicionarCarta(nome, idade, desejo, imagem) {

        const novaCarta = {
            nome: nome.trim(),
            idade: idade.trim(),
            desejo: desejo.trim() || "Brinquedo a escolher",
            imagem: imagem,
            escolhidos_por: []
        };

        try {
            const [salva] = await this.request(`/tables/cartas`, {
                method: "POST",
                body: JSON.stringify(novaCarta)
            });

            this.cartas.push({
                id: salva.id,
                nome: salva.nome,
                idade: salva.idade,
                desejo: salva.desejo,
                imagem: salva.imagem,
                escolhidosPor: salva.escolhidos_por
            });

            this.renderizar();
            return true;

        } catch (err) {
            console.error("Erro ao adicionar:", err);
            alert("Erro ao adicionar cartinha!");
            return false;
        }
    }

    validarEmail(email) {
        return email.endsWith('@zappts.com.br');
    }

    /* ============================
        ESCOLHER CARTA
    ============================ */
    async escolherCarta(cartaId, email) {
        const carta = this.cartas.find(c => c.id === cartaId);
        if (!carta) return false;

        if (carta.escolhidosPor.includes(email)) return true;

        const novaLista = [...carta.escolhidosPor, email];

        try {
            const [atualizada] = await this.request(`/tables/cartas?id=eq.${cartaId}`, {
                method: "PATCH",
                body: JSON.stringify({ escolhidos_por: novaLista })
            });

            carta.escolhidosPor = atualizada.escolhidos_por;
            this.renderizar();
            return true;

        } catch (err) {
            console.error("Erro ao escolher:", err);
            return false;
        }
    }

    /* ============================
        REMOVER ESCOLHA
    ============================ */
    async removerEscolha(cartaId, email) {
        const carta = this.cartas.find(c => c.id === cartaId);
        if (!carta) return;

        const novaLista = carta.escolhidosPor.filter(e => e !== email);

        try {
            const [atualizada] = await this.request(`/tables/cartas?id=eq.${cartaId}`, {
                method: "PATCH",
                body: JSON.stringify({ escolhidos_por: novaLista })
            });

            carta.escolhidosPor = atualizada.escolhidos_por;
            this.renderizar();

        } catch (err) {
            console.error("Erro ao remover escolha:", err);
        }
    }

    /* ============================
        DELETAR CARTA
    ============================ */
    deletarCarta(cartaId) {
        this.cartaIdParaDeletar = cartaId;
        this.abrirModalSenhaDelete();
    }

    async confirmarDelete() {
        const senha = document.getElementById('senhaDelete').value;
        const erroDiv = document.getElementById('erroSenhaDelete');

        if (senha !== this.senhaRelatorio) {
            erroDiv.classList.remove("hidden");
            return;
        }

        try {
            await this.request(`/tables/cartas?id=eq.${this.cartaIdParaDeletar}`, {
                method: "DELETE"
            });

            this.cartas = this.cartas.filter(c => c.id !== this.cartaIdParaDeletar);
            document.getElementById('modais').innerHTML = '';
            this.renderizar();

        } catch (err) {
            console.error("Erro ao excluir:", err);
            alert("Falha ao excluir cartinha");
        }
    }

    /* ============================
        RELAT√ìRIO CSV
    ============================ */
    baixarRelatorio(senha) {
        if (senha !== this.senhaRelatorio) return false;

        let conteudo = 'N¬∫ Cartinha,Nome,Idade,Desejo,Zappters que escolheram,Total\n';

        this.cartas.forEach((c, i) => {
            const emails = c.escolhidosPor.join('; ');
            conteudo += `${i + 1},"${c.nome}",${c.idade},"${c.desejo}","${emails}",${c.escolhidosPor.length}\n`;
        });

        const blob = new Blob([conteudo], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.href = url;
        link.download = `natal-solidario-${new Date().toLocaleDateString()}.csv`;
        link.click();

        return true;
    }

    /* ============================
        RENDERIZA√á√ÉO COMPLETA
    ============================ */
    renderizar() {
        const app = document.getElementById('app');

        app.innerHTML = `

        <div class="min-h-screen p-8" style="background: linear-gradient(135deg, #0c1e3a 0%, #1a2f5a 50%, #0d1929 100%); background-attachment: fixed;">

            <div class="absolute inset-0 pointer-events-none overflow-hidden">
                ${Array.from({length: 100}, () => `
                    <div class="star absolute rounded-full bg-white"
                    style="width:${Math.random()*2}px;height:${Math.random()*2}px;left:${Math.random()*100}%;top:${Math.random()*100}%"></div>
                `).join('')}
            </div>

            <div class="max-w-7xl mx-auto relative z-10">

                <div class="text-center mb-12">
                    <div class="text-7xl font-black tracking-wider mb-8" style="color:#0891b2;font-family:Arial;">
                        zappts
                    </div>

                    <h1 class="text-7xl font-black text-white mb-8 drop-shadow-2xl" style="font-family:Arial;">
                        üéÑ Natal Solid√°rio 2025 üéÑ
                    </h1>

                    <p class="text-3xl text-white mb-8 font-black drop-shadow-lg" style="font-family:Arial;">
                        Escolha uma cartinha e realize seu sonho de Natal!
                    </p>

                    <div class="inline-block bg-cyan-500 bg-opacity-30 backdrop-blur px-8 py-4 rounded-xl border-2 border-cyan-400">
                        <p class="text-white font-bold text-lg">
                            ‚ú® ${this.cartas.length} cartinhas ‚Ä¢ ${this.cartas.reduce((s,c)=>s+c.escolhidosPor.length,0)} escolhas realizadas
                        </p>
                    </div>
                </div>

                <div class="flex justify-center gap-4 mb-8 flex-wrap">
                    <button onclick="app.abrirModalNovaCarta()" class="bg-cyan-400 hover:bg-cyan-300 text-blue-900 font-bold py-3 px-8 rounded-xl">
                        ‚ûï Adicionar Nova Cartinha
                    </button>

                    <button onclick="app.abrirModalInfo()" class="bg-white hover:bg-gray-100 text-blue-700 font-bold py-3 px-8 rounded-xl">
                        ‚ÑπÔ∏è Saiba Mais
                    </button>

                    <button onclick="app.abrirModalSenha()"
                    ${this.cartas.length===0?'disabled':''}
                    class="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-bold py-3 px-8 rounded-xl">
                        üìä Baixar Relat√≥rio
                    </button>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-12">
                    ${this.cartas.length>0 ? this.cartas.map((c,i)=>`
                        <div class="relative rounded-xl overflow-hidden shadow-xl hover:shadow-2xl transition">
                            <div class="p-4 rounded-xl bg-gradient-to-br from-emerald-300 to-emerald-400 h-64 flex flex-col justify-between hover:scale-105 transition-transform cursor-pointer"
                                 onclick="app.abrirModalEscolha(${c.id})">

                                <div class="flex justify-between">
                                    <span class="bg-blue-700 text-white px-2 py-1 rounded-full text-xs font-black">#${i+1}</span>
                                    <button onclick="event.stopPropagation(); app.deletarCarta(${c.id})"
                                        class="text-blue-800 hover:text-blue-950 bg-white rounded-full p-1 shadow-lg">‚úï</button>
                                </div>

                                <div class="text-center flex-1 flex items-center justify-center">
                                    ${c.imagem
                                        ? `<img src="${c.imagem}" class="w-20 h-20 object-cover rounded-lg cursor-pointer"
                                                onclick="event.stopPropagation(); app.ampliarImagem('${c.imagem}')">`
                                        : '<p class="text-5xl">üòä</p>'}
                                </div>

                                <div class="text-center">
                                    <p class="font-black text-blue-900 text-sm">${c.nome}</p>
                                    <p class="text-xs text-blue-800 font-semibold">${c.idade} anos</p>
                                    <p class="text-xs text-blue-700 mt-1 italic font-semibold">${c.desejo}</p>
                                </div>

                                <div class="text-center">
                                    <p class="text-xs font-black bg-blue-700 text-white py-1 px-2 rounded-lg">
                                        üë• ${c.escolhidosPor.length} ${c.escolhidosPor.length===1?'escolheu':'escolheram'}
                                    </p>
                                </div>

                            </div>
                        </div>
                    `).join('') : `
                        <div class="col-span-full text-center py-20 text-white text-2xl font-bold">Nenhuma cartinha adicionada ainda! üéÑ</div>
                    `}
                </div>

                ${this.cartas.some(c=>c.escolhidosPor.length>0) ? `
                    <div class="bg-white bg-opacity-95 rounded-xl p-6 shadow-2xl border-2 border-cyan-400">
                        <h2 class="text-3xl font-black text-blue-700 mb-4">üìã Escolhas Realizadas</h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${this.cartas.filter(c=>c.escolhidosPor.length>0).map(c=>`
                                <div class="bg-gradient-to-br from-cyan-50 to-blue-50 p-4 rounded-lg border-2 border-cyan-400">
                                    <p class="font-black text-blue-700 mb-2">Cartinha #${this.cartas.indexOf(c)+1}</p>
                                    <p class="font-bold text-gray-800">${c.nome}, ${c.idade} anos</p>
                                    <p class="text-sm text-gray-600 mb-3 font-semibold">Desejo: ${c.desejo}</p>

                                    <p class="text-xs font-bold text-blue-700">Escolhido por:</p>

                                    ${c.escolhidosPor.map(email=>`
                                        <div class="flex justify-between items-center bg-white p-2 rounded border border-cyan-300">
                                            <span class="text-sm text-gray-700 font-semibold">üë§ ${email}</span>
                                            <button onclick="app.removerEscolha(${c.id}, '${email}')" class="text-blue-600 hover:text-blue-800 font-bold">‚úï</button>
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>

                    </div>
                ` : ''}

            </div>

            <div id="modais"></div>

        </div>
        `;

        window.app = this;
    }

    /* ============================
        MODAIS ‚Äî COMPLETO
    ============================ */

    abrirModalNovaCarta() {
        document.getElementById('modais').innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">

                <h2 class="text-2xl font-black text-blue-700 mb-4">Adicionar Nova Cartinha üéÅ</h2>

                <div class="space-y-4 mb-6">
                    <input id="nomeCarta" placeholder="Nome" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg">
                    <input id="idadeCarta" placeholder="Idade" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg">
                    <input id="desejoCarta" placeholder="Desejo (opcional)" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg">
                    <input type="file" id="imagemCarta" accept="image/*" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg">
                </div>

                <div class="flex gap-3">
                    <button onclick="document.getElementById('modais').innerHTML=''"
                        class="flex-1 px-4 py-2 bg-gray-400 text-white rounded-lg">Cancelar</button>

                    <button onclick="app.confirmarNovaCarta()"
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg">Adicionar</button>
                </div>

            </div>
        </div>`;
    }

    confirmarNovaCarta() {
        const nome = document.getElementById('nomeCarta').value;
        const idade = document.getElementById('idadeCarta').value;
        const desejo = document.getElementById('desejoCarta').value;
        const imagemInput = document.getElementById('imagemCarta');

        if (!nome.trim() || !idade.trim()) {
            alert("Preencha nome e idade!");
            return;
        }

        if (imagemInput.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                this.adicionarCarta(nome, idade, desejo, e.target.result);
                document.getElementById('modais').innerHTML = '';
            };
            reader.readAsDataURL(imagemInput.files[0]);
        } else {
            this.adicionarCarta(nome, idade, desejo, null);
            document.getElementById('modais').innerHTML = '';
        }
    }

    abrirModalEscolha(cartaId) {
        const c = this.cartas.find(x=>x.id===cartaId);

        document.getElementById('modais').innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">

                <h2 class="text-2xl font-black text-blue-700 mb-4">Escolher Cartinha üéÅ</h2>

                <div class="bg-gradient-to-br from-emerald-100 to-cyan-100 p-4 rounded-lg mb-6 text-center border-2 border-emerald-400">
                    ${c.imagem
                        ? `<img src="${c.imagem}" class="w-24 h-24 object-cover rounded-lg mx-auto mb-2">`
                        : '<p class="text-5xl mb-2">üòä</p>'}

                    <p class="font-black text-lg text-blue-900">${c.nome}</p>
                    <p class="text-blue-800 font-bold">${c.idade} anos</p>
                    <p class="text-sm text-blue-700 mt-2 font-bold">Desejo: ${c.desejo}</p>
                </div>

                <input type="email" id="emailEscolha" placeholder="seu.email@zappts.com.br"
                    class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg mb-4">

                <div id="erroEmail" class="text-red-600 text-sm font-bold mb-4 hidden">
                    ‚ö†Ô∏è Email deve terminar com @zappts.com.br
                </div>

                <div class="flex gap-3">
                    <button onclick="document.getElementById('modais').innerHTML=''"
                        class="flex-1 px-4 py-2 bg-gray-400 text-white rounded-lg">Cancelar</button>

                    <button onclick="app.confirmarEscolha(${cartaId})"
                        class="flex-1 px-4 py-2 bg-cyan-400 text-blue-900 rounded-lg font-bold">Confirmar</button>
                </div>

            </div>
        </div>`;
    }

    confirmarEscolha(cartaId) {
        const email = document.getElementById('emailEscolha').value;
        const erro = document.getElementById('erroEmail');

        if (!this.validarEmail(email)) {
            erro.classList.remove("hidden");
            return;
        }

        this.escolherCarta(cartaId, email);
        document.getElementById('modais').innerHTML = '';
    }

    abrirModalInfo() {
        document.getElementById('modais').innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-2xl w-full shadow-2xl border-2 border-cyan-400 max-h-96 overflow-y-auto">
                <h2 class="text-2xl font-black text-blue-700 mb-4">üìã Regras e Prazos</h2>

                <div class="space-y-4 text-gray-800">

                    <div>
                        <h3 class="font-black text-blue-700 mb-2 text-lg">üìÖ Cronograma:</h3>
                        <ul class="space-y-1 text-sm ml-4 font-semibold">
                            <li>‚úì <strong>Abertura:</strong> 26/11/2025</li>
                            <li>‚úì <strong>Fim das inscri√ß√µes:</strong> 05/12/2025</li>
                            <li>‚úì <strong>Distribui√ß√£o dos vouchers:</strong> 08/12/2025</li>
                            <li>‚úì <strong>Entrega dos brinquedos:</strong> 20/12/2025</li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="font-black text-blue-700 mb-2 text-lg">üéÅ Como Funciona:</h3>
                        <ul class="space-y-1 text-sm ml-4 font-semibold">
                            <li>‚Ä¢ Cada Zappter recebe R$ 50 no Caju</li>
                            <li>‚Ä¢ Pode participar individual ou em grupo</li>
                            <li>‚Ä¢ Pode juntar vouchers para brinquedos maiores</li>
                            <li>‚Ä¢ Escolhe a cartinha e compra o presente</li>
                        </ul>
                    </div>

                </div>

                <button onclick="document.getElementById('modais').innerHTML=''"
                    class="w-full mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-lg">
                    Entendi!
                </button>

            </div>
        </div>`;
    }

    abrirModalSenha() {
        document.getElementById('modais').innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">

                <h2 class="text-2xl font-black text-blue-700 mb-4">üîí Acesso ao Relat√≥rio</h2>

                <p class="text-gray-700 mb-6 font-semibold">Digite a senha:</p>

                <input id="senhaInput" type="password" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg mb-4">

                <div id="erroSenha" class="text-red-600 text-sm font-bold mb-4 hidden">
                    ‚ö†Ô∏è Senha incorreta!
                </div>

                <div class="flex gap-3">
                    <button onclick="document.getElementById('modais').innerHTML=''"
                        class="flex-1 px-4 py-2 bg-gray-400 text-white rounded-lg">Cancelar</button>

                    <button onclick="app.confirmarSenha()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg">Baixar</button>
                </div>

            </div>
        </div>`;
    }

    confirmarSenha() {
        const senha = document.getElementById('senhaInput').value;
        const erro = document.getElementById('erroSenha');

        if (this.baixarRelatorio(senha)) {
            document.getElementById('modais').innerHTML = '';
        } else {
            erro.classList.remove("hidden");
        }
    }

    abrirModalSenhaDelete() {
        document.getElementById('modais').innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">

                <h2 class="text-2xl font-black text-blue-700 mb-4">üîí Excluir Cartinha</h2>

                <p class="text-gray-700 mb-6 font-semibold">Digite a senha:</p>

                <input id="senhaDelete" type="password" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg mb-4">

                <div id="erroSenhaDelete" class="text-red-600 text-sm font-bold mb-4 hidden">
                    ‚ö†Ô∏è Senha incorreta!
                </div>

                <div class="flex gap-3">
                    <button onclick="document.getElementById('modais').innerHTML=''"
                        class="flex-1 px-4 py-2 bg-gray-400 text-white rounded-lg">Cancelar</button>

                    <button onclick="app.confirmarDelete()"
                        class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg">Excluir</button>
                </div>

            </div>
        </div>`;
    }

    ampliarImagem(src) {
        document.getElementById('modais').innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
            <div class="relative">
                <button onclick="document.getElementById('modais').innerHTML=''"
                    class="absolute -top-12 right-0 text-white text-3xl">‚úï</button>
                <img src="${src}" class="rounded-xl shadow-2xl max-w-full max-h-96 object-contain">
            </div>
        </div>`;
    }

}

window.addEventListener("load", () => new NatalSolidario());

    </script>

</body>
</html>
