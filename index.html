<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Natal Solid√°rio Zappts 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    .star {
      animation: twinkle 3s infinite;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    class NatalSolidario {
      constructor() {
        this.cartas = [];
        this.senhaRelatorio = '@People123';

        // CONTEXTO DO USU√ÅRIO
        this.meuEmail = null;
        this.minhaCartaId = null;

        // Recupera escolha anterior do localStorage (√∫ltima cartinha escolhida)
        const salvo = localStorage.getItem('natalEscolha');
        if (salvo) {
          try {
            const parsed = JSON.parse(salvo);
            this.meuEmail = parsed.email || null;
            this.minhaCartaId = parsed.cartaId || null;
          } catch (e) {
            console.error('Erro ao ler natalEscolha do localStorage', e);
          }
        }

        // CONFIG SUPABASE
        this.supabaseUrl = 'https://qykyaafhqaatlefozrvq.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5a3lhYWZocWFhdGxlZm96cnZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjEwNzMsImV4cCI6MjA3OTc5NzA3M30.Ik6O0Lm0nsYLkyXAhLQaA7qicTXhLDD4X1Bj_2Fav4Q';
        this.bucket = 'cartinhas';

        this.carregarCartas();
      }

      // ---------- SUPABASE REST ----------
      async db(path, options = {}) {
        const res = await fetch(`${this.supabaseUrl}/rest/v1${path}`, {
          ...options,
          headers: {
            apikey: this.supabaseKey,
            Authorization: `Bearer ${this.supabaseKey}`,
            ...(options.headers || {})
          }
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error('Erro Supabase DB:', txt);
          throw new Error(txt);
        }

        if (res.status === 204) return null;
        return res.json();
      }

      async uploadImagem(file) {
        const nomeArquivo = `${Date.now()}-${file.name}`;
        const urlUpload = `${this.supabaseUrl}/storage/v1/object/${this.bucket}/${encodeURIComponent(nomeArquivo)}`;

        const res = await fetch(urlUpload, {
          method: 'POST',
          headers: {
            apikey: this.supabaseKey,
            Authorization: `Bearer ${this.supabaseKey}`,
            'Content-Type': file.type
          },
          body: file
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error('Erro upload imagem:', txt);
          throw new Error(txt);
        }

        const publicUrl = `${this.supabaseUrl}/storage/v1/object/public/${this.bucket}/${encodeURIComponent(nomeArquivo)}`;
        return publicUrl;
      }

      // ---------- CARREGAR CARTAS ----------
      async carregarCartas() {
        try {
          const dados = await this.db('/cartas?select=*');

          this.cartas = (dados || []).map(row => ({
            id: row.id,
            nome: row.nome,
            idade: row.idade,
            desejo: row.desejo,
            imagem: row.imagem,
            escolhidosPor: row.escolhidos_por || []
          }));

          // Verifica se a escolha do usu√°rio j√° est√° salva
          if (this.meuEmail && this.minhaCartaId) {
            const carta = this.cartas.find(c => c.id === this.minhaCartaId);
            const aindaExiste = carta && carta.escolhidosPor.includes(this.meuEmail);
            if (!aindaExiste) {
              this.meuEmail = null;
              this.minhaCartaId = null;
              localStorage.removeItem('natalEscolha');
            }
          }
        } catch (error) {
          console.error('Erro ao carregar cartas:', error);
          this.cartas = [];
        }

        this.renderizar();
      }

      // ---------- VALIDAR EMAIL ----------
      validarEmail(email) {
        return email.endsWith('@zappts.com.br');
      }

      // ---------- ADICIONAR CARTA ----------
      async adicionarCarta(nome, idade, desejo, arquivoImagem) {
        try {
          let imagemUrl = null;

          if (arquivoImagem) {
            imagemUrl = await this.uploadImagem(arquivoImagem);
          }

          const corpo = {
            nome: nome.trim(),
            idade: idade.trim(),
            desejo: (desejo || '').trim() || 'Brinquedo a escolher',
            imagem: imagemUrl,
            escolhidos_por: []
          };

          const dados = await this.db('/cartas', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Prefer: 'return=representation'
            },
            body: JSON.stringify(corpo)
          });

          const salva = dados[0];

          this.cartas.push({
            id: salva.id,
            nome: salva.nome,
            idade: salva.idade,
            desejo: salva.desejo,
            imagem: salva.imagem,
            escolhidosPor: salva.escolhidos_por || []
          });

          this.renderizar();
          return true;
        } catch (error) {
          console.error('Erro ao adicionar cartinha:', error);
          alert('Erro ao adicionar cartinha. Veja o console.');
          return false;
        }
      }

      // ---------- ESCOLHER CARTA ----------
      async escolherCarta(cartaId, email) {
        const carta = this.cartas.find(c => c.id === cartaId);
        if (!carta) return false;

        // Se j√° existe outro email nessa cartinha, n√£o deixa sobrescrever
        if (
          carta.escolhidosPor.length > 0 &&
          !carta.escolhidosPor.includes(email)
        ) {
          return false;
        }

        // Registra no Supabase
        const novaLista = [email];

        try {
          // Atualiza a cartinha no banco de dados
          await this.db(`/cartas?id=eq.${cartaId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              Prefer: 'return=minimal'
            },
            body: JSON.stringify({ escolhidos_por: novaLista })
          });

          carta.escolhidosPor = novaLista;

          // Salva a escolha no localStorage para persist√™ncia no cliente
          this.meuEmail = email;
          this.minhaCartaId = cartaId;
          localStorage.setItem('natalEscolha', JSON.stringify({ email, cartaId }));

          this.renderizar();
          return true;
        } catch (error) {
          console.error('Erro ao registrar escolha:', error);
          alert('Erro ao registrar escolha. Veja o console.');
          return false;
        }
      }

      // ---------- REMOVER ESCOLHA ----------
      async removerEscolha(cartaId, email) {
        const carta = this.cartas.find(c => c.id === cartaId);
        if (!carta) return;

        const novaLista = carta.escolhidosPor.filter(e => e !== email);

        try {
          await this.db(`/cartas?id=eq.${cartaId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              Prefer: 'return=minimal'
            },
            body: JSON.stringify({ escolhidos_por: novaLista })
          });

          carta.escolhidosPor = novaLista;

          // Se o usu√°rio removeu a pr√≥pria escolha, limpamos o localStorage
          if (this.meuEmail && email === this.meuEmail && cartaId === this.minhaCartaId) {
            this.meuEmail = null;
            this.minhaCartaId = null;
            localStorage.removeItem('natalEscolha');
          }

          this.renderizar();
        } catch (error) {
          console.error('Erro ao remover escolha:', error);
          alert('Erro ao remover escolha. Veja o console.');
        }
      }

      // ---------- DELETAR CARTA ----------
      deletarCarta(cartaId) {
        this.cartaIdParaDeletar = cartaId;
        this.abrirModalSenhaDelete();
      }

      async confirmarDelete() {
        const senha = document.getElementById('senhaDelete').value;
        const erroDiv = document.getElementById('erroSenhaDelete');

        if (senha !== this.senhaRelatorio) {
          erroDiv.classList.remove('hidden');
          return;
        }

        try {
          await this.db(`/cartas?id=eq.${this.cartaIdParaDeletar}`, {
            method: 'DELETE'
          });

          this.cartas = this.cartas.filter(c => c.id !== this.cartaIdParaDeletar);

          // Se a carta deletada era a escolha do usu√°rio, limpamos
          if (this.minhaCartaId === this.cartaIdParaDeletar) {
            this.meuEmail = null;
            this.minhaCartaId = null;
            localStorage.removeItem('natalEscolha');
          }

          document.getElementById('modais').innerHTML = '';
          this.renderizar();
        } catch (error) {
          console.error('Erro ao deletar cartinha:', error);
          alert('Erro ao excluir cartinha. Veja o console.');
        }
      }

      // ---------- RELAT√ìRIO ----------
      baixarRelatorio(senha) {
        if (senha !== this.senhaRelatorio) return false;

        let conteudo = 'N¬∫ Cartinha,Nome,Idade,Desejo,Zappter que Escolheu,Total de Escolhas\n';

        this.cartas.forEach((carta, index) => {
          const emails = carta.escolhidosPor.join('; ');
          const total = carta.escolhidosPor.length;
          conteudo += `${index + 1},"${carta.nome}",${carta.idade},"${carta.desejo}","${emails}",${total}\n`;
        });

        const blob = new Blob([conteudo], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        link.setAttribute('href', url);
        link.setAttribute('download', `natal-solidario-relatorio-${new Date().toLocaleDateString()}.csv`);
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        return true;
      }

      // ---------- RENDER ----------
      renderizar() {
        const app = document.getElementById('app');

        const totalCartas = this.cartas.length;
        const totalCartasOcupadas = this.cartas.filter(c => c.escolhidosPor.length > 0).length;
        const totalDisponiveis = totalCartas - totalCartasOcupadas;

        const minhaCarta = this.minhaCartaId
          ? this.cartas.find(c => c.id === this.minhaCartaId)
          : null;

        app.innerHTML = `
          <div class="min-h-screen p-8" style="background: linear-gradient(135deg, #0c1e3a 0%, #1a2f5a 50%, #0d1929 100%); background-attachment: fixed;">
            <!-- Estrelas -->
            <div class="absolute inset-0 pointer-events-none overflow-hidden">
              ${Array.from({ length: 100 }, () => `
                <div class="star absolute rounded-full bg-white" style="
                  width: ${Math.random() * 2}px;
                  height: ${Math.random() * 2}px;
                  left: ${Math.random() * 100}%;
                  top: ${Math.random() * 100}%;
                  opacity: 0.7;
                "></div>
              `).join('')}
            </div>

            <div class="max-w-7xl mx-auto relative z-10 flex flex-col min-h-screen">
              <!-- Cabe√ßalho -->
              <div class="text-center mb-12">
                <div class="flex items-center justify-center gap-6 mb-6">
                  <img src="logo-zappts.png" alt="Zappts" class="h-14 md:h-16 object-contain" />
                  <img src="bot-natal.png" class="h-32 md:h-40 object-contain" />
                </div>
                <h1 class="text-5xl md:text-7xl font-black text-white mb-8 drop-shadow-2xl" style="font-family: Arial, sans-serif; letter-spacing: 0.02em;">
                  üéÑ Natal Solid√°rio 2025 üéÑ
                </h1>
                <p class="text-2xl md:text-3xl text-white mb-8 font-black drop-shadow-lg" style="font-family: Arial, sans-serif;">
                  Escolha uma cartinha e realize um sonho de Natal!
                </p>
                
                <div class="inline-block bg-cyan-500 bg-opacity-30 backdrop-blur px-8 py-4 rounded-xl border-2 border-cyan-400 mb-4">
                  <p class="text-white font-bold text-lg">
                    ‚ú® ${totalCartas} cartinhas ‚Ä¢ ${totalCartasOcupadas} j√° escolhidas ‚Ä¢ ${totalDisponiveis} dispon√≠veis
                  </p>
                </div>

                ${
                  minhaCarta && this.meuEmail
                    ? `
                      <div class="max-w-xl mx-auto bg-white bg-opacity-95 rounded-xl p-4 border-2 border-emerald-400 mb-6 text-left">
                        <p class="text-xs font-bold text-emerald-700 mb-1 uppercase tracking-wide">Sua participa√ß√£o</p>
                        <p class="text-sm font-semibold text-gray-800 mb-2">
                          Voc√™ escolheu a <span class="font-black text-blue-700">Cartinha #${this.cartas.indexOf(minhaCarta) + 1}</span>.
                        </p>
                        <p class="text-sm text-gray-700"><span class="font-bold">Crian√ßa:</span> ${minhaCarta.nome}, ${minhaCarta.idade} anos</p>
                        <p class="text-sm text-gray-700"><span class="font-bold">Desejo:</span> ${minhaCarta.desejo}</p>
                        <p class="text-xs text-gray-500 mt-2">Se precisar alterar, fale com o time de People.</p>
                      </div>
                    `
                    : ''
                }

                <!-- Bot√£o principal (para todos) -->
                <div class="flex justify-center mb-4">
                  <button onclick="app.abrirModalInfo()" class="bg-white hover:bg-gray-100 text-blue-700 font-bold py-3 px-8 rounded-xl flex items-center gap-2 transition shadow-xl text-lg">
                    ‚ÑπÔ∏è Saiba Mais
                  </button>
                </div>
              </div>

              <!-- Grid de Cartas -->
              <div class="flex-1">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-12">
                  ${
                    this.cartas.length > 0
                      ? this.cartas.map((c, i) => {
                          const ocupada = c.escolhidosPor.length > 0;
                          const eMinha = this.minhaCartaId === c.id && this.meuEmail && c.escolhidosPor.includes(this.meuEmail);

                          return `
                            <div class="relative rounded-xl overflow-hidden shadow-xl hover:shadow-2xl transition">
                              <div class="p-4 rounded-xl bg-gradient-to-br from-emerald-300 to-emerald-400 h-64 flex flex-col justify-between ${
                                ocupada && !eMinha ? 'opacity-60 cursor-not-allowed' : 'hover:scale-105 cursor-pointer'
                              } transition-transform" ${
                                ocupada && !eMinha
                                  ? ''
                                  : `onclick="app.abrirModalEscolha(${c.id})"`
                              }>
                                <div class="flex justify-between items-start">
                                  <div class="flex flex-col gap-1">
                                    <span class="inline-block bg-blue-700 text-white px-2 py-1 rounded-full text-xs font-black">#${i + 1}</span>
                                    ${
                                      eMinha
                                        ? `<span class="inline-block bg-white text-blue-800 px-2 py-1 rounded-full text-[10px] font-black border border-blue-800">Sua cartinha üíô</span>`
                                        : ocupada
                                          ? `<span class="inline-block bg-red-700 text-white px-2 py-1 rounded-full text-[10px] font-black">J√° escolhida</span>`
                                          : `<span class="inline-block bg-emerald-700 text-white px-2 py-1 rounded-full text-[10px] font-black">Dispon√≠vel</span>`
                                    }
                                  </div>
                                  <button onclick="event.stopPropagation(); app.deletarCarta(${c.id})" class="text-blue-800 hover:text-blue-950 bg-white rounded-full p-1 shadow-lg">‚úï</button>
                                </div>
                                <div class="text-center flex-1 flex items-center justify-center">
                                  ${
                                    c.imagem
                                      ? `<img src="${c.imagem}" class="w-20 h-20 object-cover rounded-lg ${ocupada && !eMinha ? '' : 'cursor-pointer'}" ${
                                          ocupada && !eMinha
                                            ? ''
                                            : `onclick="event.stopPropagation(); app.ampliarImagem('${c.imagem}')"`
                                        }>`
                                      : '<p class="text-5xl">üòä</p>'
                                  }
                                </div>
                                <div class="text-center">
                                  <p class="font-black text-blue-900 text-sm">${c.nome}</p>
                                  <p class="text-xs text-blue-800 font-semibold">${c.idade} anos</p>
                                  <p class="text-xs text-blue-700 mt-1 italic font-semibold">${c.desejo}</p>
                                </div>
                                <div class="text-center">
                                  <p class="text-xs font-black bg-blue-700 text-white py-1 px-2 rounded-lg">
                                    üë§ ${c.escolhidosPor.length === 0 ? 'Ainda ningu√©m escolheu' : 'J√° tem um Zappter respons√°vel'}
                                  </p>
                                </div>
                              </div>
                            </div>
                          `;
                        }).join('')
                      : '<div class="col-span-full text-center py-20 text-white text-2xl font-bold">Nenhuma cartinha adicionada ainda! üéÑ</div>'
                  }
                </div>

                <!-- Resumo de Escolhas -->
                ${
                  this.cartas.some(c => c.escolhidosPor.length > 0)
                    ? `
                    <div class="bg-white bg-opacity-95 rounded-xl p-6 shadow-2xl border-2 border-cyan-400 mb-8">
                      <h2 class="text-3xl font-black text-blue-700 mb-4">üìã Escolhas Realizadas</h2>
                      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${
                          this.cartas
                            .filter(c => c.escolhidosPor.length > 0)
                            .map(c => `
                              <div class="bg-gradient-to-br from-cyan-50 to-blue-50 p-4 rounded-lg border-2 border-cyan-400">
                                <p class="font-black text-blue-700 mb-2">Cartinha #${this.cartas.indexOf(c) + 1}</p>
                                <p class="text-gray-800 font-bold">${c.nome}, ${c.idade} anos</p>
                                <p class="text-sm text-gray-600 mb-3 font-semibold">Desejo: ${c.desejo}</p>
                                <div class="space-y-1">
                                  <p class="text-xs font-bold text-blue-700">Respons√°vel:</p>
                                  ${
                                    c.escolhidosPor.map(email => `
                                      <div class="flex justify-between items-center bg-white p-2 rounded border border-cyan-300">
                                        <span class="text-sm text-gray-700 font-semibold">üë§ ${email}</span>
                                        <button onclick="app.removerEscolha(${c.id}, '${email}')" class="text-blue-600 hover:text-blue-800 font-bold">‚úï</button>
                                      </div>
                                    `).join('')
                                  }
                                </div>
                              </div>
                            `).join('')
                        }
                      </div>
                    </div>
                  `
                    : ''
                }
              </div>

              <!-- A√ß√µes administrativas, discretas, no rodap√© √† direita -->
              <div class="mt-4 flex justify-end gap-6 pr-4 text-sm opacity-70 hover:opacity-100 transition-all">
                <button 
                  onclick="app.abrirModalSenhaAdmin()" 
                  class="text-cyan-300 hover:text-cyan-100 font-semibold flex items-center gap-1">
                    ‚ûï Adicionar cartinha
                </button>

                <button 
                  onclick="app.abrirModalSenha()" 
                  class="text-green-300 hover:text-green-100 font-semibold flex items-center gap-1">
                    üìÑ Baixar relat√≥rio
                </button>
              </div>
            </div>

            <!-- Modais -->
            <div id="modais"></div>
          </div>
        `;

        window.app = this;
      }

      // ---------- MODAL SENHA ADMIN (ANTES DE NOVA CARTA) ----------
      abrirModalSenhaAdmin() {
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">
              <h2 class="text-2xl font-black text-blue-700 mb-4">üîí Acesso para adicionar cartinha</h2>
              <p class="text-gray-700 mb-6 font-semibold">Digite a senha de People:</p>
              <input type="password" id="senhaAdmin" placeholder="Digite a senha" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold mb-4">
              <div id="erroSenhaAdmin" class="text-red-600 text-sm font-bold mb-4 hidden">‚ö†Ô∏è Senha incorreta!</div>
              <div class="flex gap-3">
                <button onclick="document.getElementById('modais').innerHTML = ''" class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">Cancelar</button>
                <button onclick="app.confirmarSenhaAdmin()" class="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg text-lg">Confirmar</button>
              </div>
            </div>
          </div>
        `;
      }

      confirmarSenhaAdmin() {
        const senha = document.getElementById('senhaAdmin').value;
        const erroDiv = document.getElementById('erroSenhaAdmin');

        if (senha !== this.senhaRelatorio) {
          erroDiv.classList.remove('hidden');
          return;
        }

        document.getElementById('modais').innerHTML = '';
        this.abrirModalNovaCarta();
      }

      // ---------- MODAIS ----------
      abrirModalNovaCarta() {
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">
              <h2 class="text-2xl font-black text-blue-700 mb-4">Adicionar Nova Cartinha üéÅ</h2>
              <div class="space-y-4 mb-6">
                <input type="text" id="nomeCarta" placeholder="Nome da cartinha" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold">
                <input type="text" id="idadeCarta" placeholder="Idade" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold">
                <input type="text" id="desejoCarta" placeholder="O que deseja (opcional)" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold">
                <input type="file" id="imagemCarta" accept="image/*" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg">
              </div>
              <div class="flex gap-3">
                <button onclick="document.getElementById('modais').innerHTML = ''" class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">Cancelar</button>
                <button onclick="app.confirmarNovaCarta()" class="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg text-lg">Adicionar</button>
              </div>
            </div>
          </div>
        `;
      }

      async confirmarNovaCarta() {
        const nome = document.getElementById('nomeCarta').value;
        const idade = document.getElementById('idadeCarta').value;
        const desejo = document.getElementById('desejoCarta').value;
        const imagemInput = document.getElementById('imagemCarta');
        const arquivo = imagemInput.files[0] || null;

        if (!nome.trim() || !idade.trim()) {
          alert('Preencha nome e idade!');
          return;
        }

        await this.adicionarCarta(nome, idade, desejo, arquivo);
        document.getElementById('modais').innerHTML = '';
      }

      abrirModalEscolha(cartaId) {
        const carta = this.cartas.find(c => c.id === cartaId);
        const modaisDiv = document.getElementById('modais');

        const ocupada = carta.escolhidosPor.length > 0;

        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400 max-h-[90vh] overflow-y-auto">
              <h2 class="text-2xl font-black text-blue-700 mb-4">Escolher uma Cartinha üéÅ</h2>
              <div class="bg-gradient-to-br from-emerald-100 to-cyan-100 p-4 rounded-lg mb-6 text-center border-2 border-emerald-400">
                ${
                  carta.imagem
                    ? `<img src="${carta.imagem}" class="w-24 h-24 object-cover rounded-lg mx-auto mb-2">`
                    : '<p class="text-5xl mb-2">üòä</p>'
                }
                <p class="font-black text-lg text-blue-900">${carta.nome}</p>
                <p class="text-blue-800 font-bold">${carta.idade} anos</p>
                <p class="text-sm text-blue-700 mt-2 font-bold">Desejo: ${carta.desejo}</p>
                ${
                  ocupada
                    ? `<p class="mt-3 text-sm text-red-700 font-bold">Esta cartinha j√° foi escolhida. Se precisar ajustar, fale com o time de People.</p>`
                    : ''
                }
              </div>

              ${
                ocupada
                  ? `
                    <button onclick="document.getElementById('modais').innerHTML = ''" class="w-full mt-2 px-4 py-2 bg-gray-500 text-white font-bold rounded-lg text-lg">Fechar</button>
                  `
                  : `
                    <p class="text-xs text-gray-600 font-semibold mb-2">
                      Cada cartinha pode ser escolhida por <span class="font-bold">uma</span> pessoa. 
                      Se quiser escolher mais de uma cartinha, repita o processo com o mesmo e-mail.
                    </p>

                    <input type="email" id="emailEscolha" placeholder="seu.email@zappts.com.br" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold mb-3">

                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-3 text-xs font-semibold text-yellow-900 mb-3">
                      <p>
                        Ao confirmar, voc√™ est√° assumindo um compromisso com essa crian√ßa: 
                        comprar e enviar o presente dentro do prazo combinado. 
                        Ela est√° esperando por voc√™. üíõ
                      </p>
                    </div>

                    <div class="flex items-start gap-2 mb-3">
                      <input type="checkbox" id="aceiteTermo" class="mt-1">
                      <label for="aceiteTermo" class="text-xs text-gray-700 font-semibold">
                        Li e estou ciente de que estou assumindo um compromisso de presentear esta crian√ßa dentro do prazo informado.
                      </label>
                    </div>

                    <div id="erroEmail" class="text-red-600 text-xs font-bold mb-1 hidden">
                      ‚ö†Ô∏è Email deve terminar com @zappts.com.br
                    </div>
                    <div id="erroTermo" class="text-red-600 text-xs font-bold mb-1 hidden">
                      ‚ö†Ô∏è Voc√™ precisa aceitar o compromisso antes de confirmar.
                    </div>
                    <div id="erroEscolha" class="text-red-600 text-xs font-bold mb-3 hidden"></div>

                    <div class="flex gap-3 mt-4">
                      <button onclick="document.getElementById('modais').innerHTML = ''" class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">Cancelar</button>
                      <button onclick="app.confirmarEscolha(${cartaId})" class="flex-1 px-4 py-2 bg-cyan-400 text-blue-900 font-bold rounded-lg text-lg">Confirmar</button>
                    </div>
                  `
              }
            </div>
          </div>
        `;
      }

      async confirmarEscolha(cartaId) {
        const email = document.getElementById('emailEscolha').value.trim();
        const aceite = document.getElementById('aceiteTermo').checked;

        const erroEmail = document.getElementById('erroEmail');
        const erroTermo = document.getElementById('erroTermo');
        const erroEscolha = document.getElementById('erroEscolha');

        // Reseta mensagens
        erroEmail.classList.add('hidden');
        erroTermo.classList.add('hidden');
        erroEscolha.classList.add('hidden');
        erroEscolha.textContent = '';

        if (!this.validarEmail(email)) {
          erroEmail.classList.remove('hidden');
          return;
        }

        if (!aceite) {
          erroTermo.classList.remove('hidden');
          return;
        }

        const carta = this.cartas.find(c => c.id === cartaId);
        if (!carta) {
          erroEscolha.textContent = 'Erro ao localizar a cartinha. Tente novamente.';
          erroEscolha.classList.remove('hidden');
          return;
        }

        // Regra principal: UMA PESSOA por cartinha
        if (
          carta.escolhidosPor.length > 0 &&
          !carta.escolhidosPor.includes(email)
        ) {
          erroEscolha.textContent = '‚ö†Ô∏è Esta cartinha j√° foi escolhida por outra pessoa. Escolha outra cartinha, por favor.';
          erroEscolha.classList.remove('hidden');
          return;
        }

        const ok = await this.escolherCarta(cartaId, email);
        if (ok) {
          document.getElementById('modais').innerHTML = '';
        } else {
          erroEscolha.textContent = '‚ö†Ô∏è N√£o foi poss√≠vel registrar a escolha. Tente novamente ou fale com o time de People.';
          erroEscolha.classList.remove('hidden');
        }
      }
    }

    // Inicializa quando a p√°gina carrega
    window.addEventListener('load', () => {
      new NatalSolidario();
    });
  </script>
</body>
</html>

