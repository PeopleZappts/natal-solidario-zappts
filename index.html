class NatalSolidario {
  constructor() {
    this.cartas = [];
    this.senhaRelatorio = '@People123';

    // CONTEXTO DO USUÃRIO
    this.meuEmail = null;
    this.minhaCartaId = null;
    this.numeroCartaEscolhida = null;  // NÃºmero da cartinha que o usuÃ¡rio escolheu

    // Recupera escolha anterior do localStorage (Ãºltima cartinha escolhida)
    const salvo = localStorage.getItem('natalEscolha');
    if (salvo) {
      try {
        const parsed = JSON.parse(salvo);
        this.meuEmail = parsed.email || null;
        this.minhaCartaId = parsed.cartaId || null;
        this.numeroCartaEscolhida = parsed.numeroCarta || null;  // Recupera o nÃºmero da cartinha escolhida
      } catch (e) {
        console.error('Erro ao ler natalEscolha do localStorage', e);
      }
    }

    // CONFIG SUPABASE
    this.supabaseUrl = 'https://qykyaafhqaatlefozrvq.supabase.co';
    this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5a3lhYWZocWFhdGxlZm96cnZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjEwNzMsImV4cCI6MjA3OTc5NzA3M30.Ik6O0Lm0nsYLkyXAhLQaA7qicTXhLDD4X1Bj_2Fav4Q';
    this.bucket = 'cartinhas';

    this.carregarCartas();
  }

  // ---------- SUPABASE REST ----------
  async db(path, options = {}) {
    const res = await fetch(`${this.supabaseUrl}/rest/v1${path}`, {
      ...options,
      headers: {
        apikey: this.supabaseKey,
        Authorization: `Bearer ${this.supabaseKey}`,
        ...(options.headers || {})
      }
    });

    if (!res.ok) {
      const txt = await res.text();
      console.error('Erro Supabase DB:', txt);
      throw new Error(txt);
    }

    if (res.status === 204) return null;
    return res.json();
  }

  // ---------- ADICIONAR ESCOLHA ----------
  async registrarEscolha(email, cartaId, numeroCartao) {
    try {
      const corpo = {
        email: email,
        cartinha_id: cartaId,
        numero_cartao: numeroCartao
      };

      const dados = await this.db('/escolhas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Prefer: 'return=representation'
        },
        body: JSON.stringify(corpo)
      });

      // Caso o registro seja feito com sucesso
      console.log('Escolha registrada com sucesso:', dados);

      // Salva no localStorage para persistÃªncia local
      this.meuEmail = email;
      this.minhaCartaId = cartaId;
      this.numeroCartaEscolhida = numeroCartao;  // Salvando o nÃºmero da cartinha escolhida
      localStorage.setItem('natalEscolha', JSON.stringify({ email, cartaId, numeroCarta: numeroCartao }));

      this.renderizar();
      return true;
    } catch (error) {
      console.error('Erro ao registrar escolha:', error);
      alert('Erro ao registrar escolha. Veja o console.');
      return false;
    }
  }

  // ---------- ESCOLHER CARTA ----------
  async escolherCarta(cartaId, email, numeroCarta) {
    const carta = this.cartas.find(c => c.id === cartaId);
    if (!carta) return false;

    // Verifica se a cartinha jÃ¡ foi escolhida
    if (carta.escolhidosPor.length > 0 && !carta.escolhidosPor.includes(email)) {
      return false;
    }

    // Registra a escolha na tabela 'escolhas' do Supabase
    const ok = await this.registrarEscolha(email, cartaId, numeroCarta);
    if (ok) {
      carta.escolhidosPor.push(email); // Atualiza a cartinha com o novo e-mail
      this.renderizar();
      return true;
    } else {
      return false;
    }
  }

  // ---------- RENDER ----------
  renderizar() {
    const app = document.getElementById('app');

    const totalCartas = this.cartas.length;
    const totalCartasOcupadas = this.cartas.filter(c => c.escolhidosPor.length > 0).length;
    const totalDisponiveis = totalCartas - totalCartasOcupadas;

    app.innerHTML = `
      <div class="min-h-screen p-8" style="background: linear-gradient(135deg, #0c1e3a 0%, #1a2f5a 50%, #0d1929 100%); background-attachment: fixed;">
        <!-- CabeÃ§alho -->
        <div class="text-center mb-12">
          <div class="flex items-center justify-center gap-6 mb-6">
            <img src="logo-zappts.png" alt="Zappts" class="h-14 md:h-16 object-contain" />
            <img src="bot-natal.png" class="h-32 md:h-40 object-contain" />
          </div>
          <h1 class="text-5xl md:text-7xl font-black text-white mb-8 drop-shadow-2xl" style="font-family: Arial, sans-serif; letter-spacing: 0.02em;">
            ğŸ„ Natal SolidÃ¡rio 2025 ğŸ„
          </h1>
          <p class="text-2xl md:text-3xl text-white mb-8 font-black drop-shadow-lg" style="font-family: Arial, sans-serif;">
            Escolha uma cartinha e realize um sonho de Natal!
          </p>

          <div class="inline-block bg-cyan-500 bg-opacity-30 backdrop-blur px-8 py-4 rounded-xl border-2 border-cyan-400 mb-4">
            <p class="text-white font-bold text-lg">
              âœ¨ ${totalCartas} cartinhas â€¢ ${totalCartasOcupadas} jÃ¡ escolhidas â€¢ ${totalDisponiveis} disponÃ­veis
            </p>
          </div>
          <!-- BotÃ£o principal (para todos) -->
          <div class="flex justify-center mb-4">
            <button onclick="app.abrirModalInfo()" class="bg-white hover:bg-gray-100 text-blue-700 font-bold py-3 px-8 rounded-xl flex items-center gap-2 transition shadow-xl text-lg">
              â„¹ï¸ Saiba Mais
            </button>
          </div>
        </div>

        <!-- Grid de Cartas -->
        <div class="flex-1">
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-12">
            ${
              this.cartas.length > 0
                ? this.cartas.map((c, i) => `
                  <div class="relative rounded-xl overflow-hidden shadow-xl hover:shadow-2xl transition">
                    <div class="p-4 rounded-xl bg-gradient-to-br from-emerald-300 to-emerald-400 h-64 flex flex-col justify-between ${
                      c.escolhidosPor.length > 0 ? 'opacity-60' : ''
                    }">
                      <span class="inline-block bg-blue-700 text-white px-2 py-1 rounded-full text-xs font-black">#${i + 1}</span>
                      <div class="text-center flex-1 flex items-center justify-center">
                        <p class="text-2xl">${c.nome}</p>
                      </div>
                      <div class="text-center">
                        <p class="text-xs text-blue-700 mt-1 italic font-semibold">${c.desejo}</p>
                      </div>
                    </div>
                  </div>
                `).join('')
                : '<div class="col-span-full text-center py-20 text-white text-2xl font-bold">Nenhuma cartinha adicionada ainda! ğŸ„</div>'
            }
          </div>
        </div>
      </div>
    `;
  }
}


