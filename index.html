<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Natal Solid√°rio Zappts 2025</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@keyframes twinkle { 0%,100%{opacity:.3;} 50%{opacity:1;} }
.star { animation: twinkle 3s infinite; }
</style>
</head>

<body>
<div id="app"></div>

<script>
class NatalSolidario {

    supabaseUrl = "https://qykyaafhqaatlefozrvq.supabase.co";
    supabaseKey = "sb_publishable_R-N-XCpFVnUlf-5Z16VLjg_xaxCeNGp";
    bucket = "cartinhas";

    api(path, options = {}) {
        return fetch(this.supabaseUrl + path, {
            ...options,
            headers: {
                "apikey": this.supabaseKey,
                "Authorization": "Bearer " + this.supabaseKey,
                ...(options.headers || {})
            }
        }).then(async res => {
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        });
    }

    constructor(){
        this.cartas = [];
        this.senhaRelatorio = "@People123";
        this.load();
    }

    async load(){
        try {
            const data = await this.api("/rest/v1/cartas?select=*");
            this.cartas = data.map(c => ({
                id: c.id,
                nome: c.nome,
                idade: c.idade,
                desejo: c.desejo,
                imagem: c.imagem,
                escolhidosPor: c.escolhidos_por || []
            }));
        } catch(e){
            console.error(e);
        }
        this.render();
    }

    async uploadImagem(file){
        const nome = Date.now() + "_" + file.name;
        await fetch(`${this.supabaseUrl}/storage/v1/object/${this.bucket}/${nome}`, {
            method: "POST",
            headers: {
                "apikey": this.supabaseKey,
                "Authorization": "Bearer " + this.supabaseKey,
                "Content-Type": file.type
            },
            body: file
        });

        return `${this.supabaseUrl}/storage/v1/object/public/${this.bucket}/${nome}`;
    }

    async adicionarCarta(nome, idade, desejo, file){
        let imagemUrl = null;
        if (file) imagemUrl = await this.uploadImagem(file);

        const body = {
            nome, idade,
            desejo: desejo || "Brinquedo a escolher",
            imagem: imagemUrl,
            escolhidos_por: []
        };

        const saved = await this.api("/rest/v1/cartas", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });

        this.cartas.push({
            id: saved[0].id,
            ...body,
            escolhidosPor: []
        });

        this.render();
    }

    validarEmail(email){
        return email.endsWith("@zappts.com.br");
    }

    async escolherCarta(id, email){
        const c = this.cartas.find(x=>x.id===id);
        if (!c) return;

        if (!c.escolhidosPor.includes(email))
            c.escolhidosPor.push(email);

        await this.api(`/rest/v1/cartas?id=eq.${id}`, {
            method: "PATCH",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({escolhidos_por: c.escolhidosPor})
        });

        this.render();
    }

    async removerEscolha(id, email){
        const c = this.cartas.find(x=>x.id===id);
        if (!c) return;

        c.escolhidosPor = c.escolhidosPor.filter(e=>e!==email);

        await this.api(`/rest/v1/cartas?id=eq.${id}`, {
            method: "PATCH",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({escolhidos_por: c.escolhidosPor})
        });

        this.render();
    }

    async deleteCarta(id){
        await this.api(`/rest/v1/cartas?id=eq.${id}`, {method:"DELETE"});
        this.cartas = this.cartas.filter(c=>c.id!==id);
        this.render();
    }

    baixarRelatorio(s){
        if (s !== this.senhaRelatorio) return false;
        let csv = "N¬∫,Nome,Idade,Desejo,Emails,Total\n";
        this.cartas.forEach((c,i)=>{
            csv += `${i+1},"${c.nome}",${c.idade},"${c.desejo}","${c.escolhidosPor.join("; ")}",${c.escolhidosPor.length}\n`;
        });
        const blob = new Blob([csv],{type:"text/csv"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "relatorio.csv";
        a.click();
        return true;
    }

    /* ------------------------
       RENDERIZA√á√ÉO COMPLETA
    -------------------------*/
    render(){
        const app = document.getElementById("app");
        app.innerHTML = `
        <div class="min-h-screen p-8" style="background:linear-gradient(135deg,#0c1e3a,#1a2f5a,#0d1929);">

            <div class="absolute inset-0 pointer-events-none">
                ${Array.from({length:100}).map(()=>{
                    return `<div class="star absolute bg-white rounded-full"
                        style="width:${Math.random()*2}px;height:${Math.random()*2}px;left:${Math.random()*100}%;top:${Math.random()*100}%"></div>`;
                }).join("")}
            </div>

            <div class="max-w-7xl mx-auto relative z-10">

                <div class="text-center mb-12">
                    <div class="text-7xl font-black mb-4" style="color:#0891b2">zappts</div>
                    <h1 class="text-6xl font-black text-white mb-4">üéÑ Natal Solid√°rio 2025 üéÑ</h1>
                    <p class="text-2xl text-white font-bold mb-6">Escolha uma cartinha e realize um sonho!</p>

                    <div class="inline-block bg-cyan-500 bg-opacity-30 px-6 py-3 rounded-xl border-2 border-cyan-400">
                        <p class="text-white font-bold">
                        ${this.cartas.length} cartinhas ‚Ä¢
                        ${this.cartas.reduce((t,c)=>t+c.escolhidosPor.length,0)} escolhas
                        </p>
                    </div>
                </div>

                <div class="flex justify-center gap-4 mb-8">
                    <button onclick="app.modalNova()" class="bg-cyan-400 text-blue-900 font-bold py-3 px-6 rounded-xl">
                        ‚ûï Adicionar Cartinha
                    </button>

                    <button onclick="app.modalInfo()" class="bg-white text-blue-700 font-bold py-3 px-6 rounded-xl">
                        ‚ÑπÔ∏è Informa√ß√µes
                    </button>

                    <button onclick="app.modalSenha()" class="bg-green-500 text-white font-bold py-3 px-6 rounded-xl">
                        üìä Relat√≥rio
                    </button>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    ${this.cartas.map((c,i)=>`
                        <div class="bg-emerald-300 rounded-xl p-4 cursor-pointer shadow-lg hover:scale-105 transition"
                             onclick="app.modalEscolha(${c.id})">

                            <div class="flex justify-between mb-2">
                                <span class="bg-blue-700 text-white px-2 py-1 rounded-full text-xs font-bold">#${i+1}</span>
                                <button onclick="event.stopPropagation(); app.modalDelete(${c.id})" class="bg-white px-2 rounded">‚úï</button>
                            </div>

                            <div class="text-center my-2">
                                ${c.imagem ? 
                                    `<img src="${c.imagem}" class="w-20 h-20 rounded mx-auto">`
                                    : '<p class="text-5xl">üòä</p>'}
                            </div>

                            <p class="text-blue-900 font-bold text-sm text-center">${c.nome}</p>
                            <p class="text-blue-800 text-xs text-center">${c.idade} anos</p>
                            <p class="text-blue-700 text-xs italic text-center">${c.desejo}</p>

                            <p class="text-xs bg-blue-700 text-white text-center py-1 rounded mt-2 font-bold">
                                üë• ${c.escolhidosPor.length}
                            </p>

                        </div>
                    `).join("")}
                </div>

                <div id="modais"></div>

            </div>
        </div>
        `;
        window.app = this;
    }

    /* ------------------------
        MODAIS COMPLETOS
    -------------------------*/

    modalNova(){
        document.getElementById("modais").innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl max-w-md w-full">

                <h2 class="text-2xl font-bold mb-4">Adicionar Cartinha</h2>

                <input id="n1" placeholder="Nome" class="w-full border p-2 mb-2 rounded" />
                <input id="n2" placeholder="Idade" class="w-full border p-2 mb-2 rounded" />
                <input id="n3" placeholder="Desejo (opcional)" class="w-full border p-2 mb-2 rounded" />
                <input id="n4" type="file" accept="image/*" class="w-full border p-2 mb-4 rounded" />

                <div class="flex gap-4">
                    <button onclick="document.getElementById('modais').innerHTML=''"
                        class="flex-1 bg-gray-400 text-white p-2 rounded">Cancelar</button>

                    <button onclick="app.novaConfirmar()"
                        class="flex-1 bg-blue-600 text-white p-2 rounded">Adicionar</button>
                </div>

            </div>
        </div>`;
    }

    async novaConfirmar(){
        const nome = n1.value.trim();
        const idade = n2.value.trim();
        const desejo = n3.value.trim();
        const file = n4.files[0] || null;

        if (!nome || !idade){
            alert("Preencha nome e idade.");
            return;
        }

        await this.adicionarCarta(nome, idade, desejo, file);
        document.getElementById("modais").innerHTML = "";
    }

    modalEscolha(id){
        const c = this.cartas.find(x=>x.id===id);
        document.getElementById("modais").innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl max-w-md w-full">

                <h2 class="text-2xl font-bold mb-4">Escolher Cartinha</h2>

                <div class="text-center mb-4">
                    ${c.imagem ? `<img src="${c.imagem}" class="w-24 h-24 mx-auto rounded mb-2"/>`
                                : `<p class="text-5xl mb-2">üòä</p>`}
                    <p class="font-bold text-lg">${c.nome}</p>
                    <p>${c.idade} anos</p>
                    <p class="italic text-sm">${c.desejo}</p>
                </div>

                <input id="emailEscolha" placeholder="seu.email@zappts.com.br"
                    class="w-full border p-2 mb-2 rounded"/>

                <p id="erroEmail" class="hidden text-red-600 text-sm mb-2">Email inv√°lido</p>

                <div class="flex gap-4">
                    <button onclick="document.getElementById('modais').innerHTML=''"
                        class="flex-1 bg-gray-400 text-white p-2 rounded">Cancelar</button>

                    <button onclick="app.escolhaConfirmar(${id})"
                        class="flex-1 bg-cyan-400 text-blue-900 p-2 rounded font-bold">Confirmar</button>
                </div>

            </div>
        </div>`;
    }

    async escolhaConfirmar(id){
        const email = emailEscolha.value.trim();
        if (!this.validarEmail(email)){
            erroEmail.classList.remove("hidden");
            return;
        }
        await this.escolherCarta(id, email);
        document.getElementById("modais").innerHTML = "";
    }

    modalDelete(id){
        document.getElementById("modais").innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl max-w-md w-full">

                <h2 class="text-xl font-bold mb-4">Excluir Cartinha</h2>

                <input id="senhaDelete" type="password" placeholder="Senha"
                    class="w-full border p-2 mb-2 rounded"/>

                <p id="erroSenhaDelete" class="hidden text-red-600 text-sm mb-2">Senha incorreta</p>

                <div class="flex gap-4">
                    <button onclick="document.getElementById('modais').innerHTML=''"
                        class="flex-1 bg-gray-400 text-white p-2 rounded">Cancelar</button>

                    <button onclick="app.deleteConfirmar(${id})"
                        class="flex-1 bg-red-600 text-white p-2 rounded">Excluir</button>
                </div>

            </div>
        </div>`;
    }

    async deleteConfirmar(id){
        const s = senhaDelete.value;
        if (s !== this.senhaRelatorio){
            erroSenhaDelete.classList.remove("hidden");
            return;
        }
        await this.deleteCarta(id);
        document.getElementById("modais").innerHTML = "";
    }

    modalSenha(){
        document.getElementById("modais").innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl max-w-md w-full">

                <h2 class="text-xl font-bold mb-4">Relat√≥rio</h2>

                <input id="senhaInput" type="password" placeholder="Senha"
                    class="w-full border p-2 mb-2 rounded"/>

                <p id="erroSenha" class="hidden text-red-600 text-sm mb-2">Senha incorreta</p>

                <div class="flex gap-4">
                    <button onclick="document.getElementById('modais').innerHTML=''"
                        class="flex-1 bg-gray-400 text-white p-2 rounded">Cancelar</button>

                    <button onclick="app.relatorioConfirmar()"
                        class="flex-1 bg-green-600 text-white p-2 rounded">Baixar</button>
                </div>

            </div>
        </div>`;
    }

    relatorioConfirmar(){
        const s = senhaInput.value;
        if (!this.baixarRelatorio(s)){
            erroSenha.classList.remove("hidden");
            return;
        }
        document.getElementById("modais").innerHTML = "";
    }

    modalInfo(){
        document.getElementById("modais").innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl max-w-lg w-full max-h-[90vh] overflow-auto">

                <h2 class="text-xl font-bold mb-4">Informa√ß√µes</h2>

                <p class="mb-4">‚Ä¢ Cada Zappter recebe R$50 no Caju.</p>
                <p class="mb-4">‚Ä¢ Pode participar individualmente ou em grupo.</p>
                <p class="mb-4">‚Ä¢ Pode juntar vouchers.</p>
                <p class="mb-4">‚Ä¢ Escolha a cartinha e compre o presente.</p>

                <button onclick="document.getElementById('modais').innerHTML=''"
                    class="w-full bg-blue-600 text-white p-2 rounded">Fechar</button>

            </div>
        </div>`;
    }

}

window.addEventListener("load",()=>new NatalSolidario());
</script>

</body>
</html>
