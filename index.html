<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Natal Solid√°rio Zappts 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    .star { animation: twinkle 3s infinite; }
  </style>
</head>

<body>
  <div id="app"></div>

<script>
class NatalSolidario {
  constructor() {
    this.cartas = [];
    this.senhaRelatorio = '@People123';

    // CONTEXTO
    this.meuEmail = null;
    this.meuNome = null;
    this.minhaCartaId = null;

    const salvo = localStorage.getItem('natalEscolha');
    if (salvo) {
      try {
        const parsed = JSON.parse(salvo);
        this.meuEmail = parsed.email || null;
        this.meuNome  = parsed.nomeParticipante || null;
        this.minhaCartaId = parsed.cartaId || null;
      } catch(err) {}
    }

    // üîó SUPABASE
    this.supabaseUrl = "https://qykyaafhqaatlefozrvq.supabase.co";
    this.supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5a3lhYWZocWFhdGxlZm96cnZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjEwNzMsImV4cCI6MjA3OTc5NzA3M30.Ik6O0Lm0nsYLkyXAhLQaA7qicTXhLDD4X1Bj_2Fav4Q";
    this.bucket = "cartinhas";

    // üîó WEBHOOK
    this.webhookUrl = "https://zpt-dev.zappts.com.br/webhook/natal-zappts-2025";

    this.carregarCartas();
  }

  // ========================= SUPABASE =========================

  async db(path, options = {}) {
    const res = await fetch(
      `${this.supabaseUrl}/rest/v1${path}`,
      {
        ...options,
        headers: {
          apikey: this.supabaseKey,
          Authorization: `Bearer ${this.supabaseKey}`,
          ...(options.headers || {})
        }
      }
    );

    if (!res.ok) throw new Error(await res.text());
    if (res.status === 204) return null;
    return res.json();
  }

  async uploadImagem(file) {
    const nome = `${Date.now()}-${file.name}`;
    const urlUpload = `${this.supabaseUrl}/storage/v1/object/${this.bucket}/${encodeURIComponent(nome)}`;

    const r = await fetch(urlUpload, {
      method: "POST",
      headers: {
        "Content-Type": file.type,
        apikey: this.supabaseKey,
        Authorization: `Bearer ${this.supabaseKey}`
      },
      body: file
    });

    if (!r.ok) throw new Error("Erro upload imagem");

    return `${this.supabaseUrl}/storage/v1/object/public/${this.bucket}/${encodeURIComponent(nome)}`;
  }

  // ========================= CARREGAR CARTINHAS =========================

  async carregarCartas() {
    try {
      const dados = await this.db("/cartas?select=*");

      this.cartas = dados.map(row => ({
        id: row.id,
        nome: row.nome,
        idade: row.idade,
        desejo: row.desejo,
        imagem: row.imagem,
        numero_cartao: row.numero_cartao,
        escolhidosPor: row.escolhidos_por || []
      }));
    } catch(err) {
      console.error(err);
      this.cartas = [];
    }

    this.renderizar();
  }

  validarEmail(email) {
    return email.endsWith("@zappts.com.br");
  }

  // ========================= ADICIONAR NOVA CARTA =========================

  async adicionarCarta(numero, nome, idade, desejo, arquivoImagem) {
    try {
      let imagemUrl = null;
      if (arquivoImagem) imagemUrl = await this.uploadImagem(arquivoImagem);

      const corpo = {
        numero_cartao: numero,
        nome,
        idade,
        desejo: desejo || "Brinquedo",
        imagem: imagemUrl,
        escolhidos_por: []
      };

      const ret = await this.db("/cartas", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Prefer: "return=representation"
        },
        body: JSON.stringify(corpo)
      });

      this.cartas.push({
        id: ret[0].id,
        nome,
        idade,
        desejo,
        imagem: imagemUrl,
        numero_cartao: numero,
        escolhidosPor: []
      });

      this.renderizar();
      return true;

    } catch (err) {
      console.error("Erro ao adicionar:", err);
      alert("Erro ao adicionar cartinha.");
      return false;
    }
  }

  // ========================= REGISTRO + WEBHOOK =========================

  async dispararWebhookEscolha({ email, nomeParticipante, carta }) {
    try {
      await fetch(this.webhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: email,
          nome_participante: nomeParticipante,
          carta_id: carta.id,
          numero_cartao: carta.numero_cartao,
          nome_crianca: carta.nome,
          idade_crianca: carta.idade,
          desejo: carta.desejo,
          imagem: carta.imagem
        })
      });
    } catch(err) {
      console.error("Webhook erro:", err);
    }
  }

  async sortearOuRegistrar(email, nomeParticipante) {
    let carta = this.cartas.find(c => c.escolhidosPor.includes(email));

    if (!carta) {
      const livres = this.cartas.filter(c => c.escolhidosPor.length === 0);
      if (livres.length === 0) return null;

      carta = livres[Math.floor(Math.random() * livres.length)];

      try {
        await this.db(`/cartas?id=eq.${carta.id}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Prefer: "return=minimal"
          },
          body: JSON.stringify({
            escolhidos_por: [email]
          })
        });

        carta.escolhidosPor = [email];

      } catch(err) {
        console.error("Erro PATCH:", err);
        return null;
      }

      // registrar hist√≥rico:
      try {
        await this.db("/escolhas", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Prefer: "return=minimal"
          },
          body: JSON.stringify({
            email,
            cartinha_id: carta.id,
            numero_cartao: carta.numero_cartao
          })
        });
      } catch(err) {
        console.error("Erro INSERT escolhas:", err);
      }

      // disparar webhook
      this.dispararWebhookEscolha({ email, nomeParticipante, carta });
    }

    this.meuEmail = email;
    this.meuNome = nomeParticipante;
    this.minhaCartaId = carta.id;

    localStorage.setItem("natalEscolha", JSON.stringify({
      email,
      nomeParticipante,
      cartaId: carta.id
    }));

    return carta;
  }

  // ========================= UI ‚Äì MODAIS =========================

  abrirModalParticipar() {
    document.getElementById("modais").innerHTML = `
      <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-8 max-w-xl w-full shadow-2xl border-2 border-cyan-400 max-h-[95vh] overflow-y-auto">

          <h2 class="text-3xl font-black text-blue-700 mb-4 text-center">üé• Conhe√ßa o Instituto</h2>

          <video id="videoInstituto" class="w-full rounded-lg mb-4" controls>
            <source src="./videos/instituto.mp4" type="video/mp4" />
            Seu navegador n√£o suporta v√≠deo.
          </video>

          <p class="text-gray-700 font-semibold text-sm mb-3">
            Depois de assistir, preencha suas informa√ß√µes abaixo para participar do Natal Solid√°rio.
          </p>

          <input id="nomeParticipante" placeholder="Seu nome completo" class="w-full px-4 py-2 border rounded mb-3">
          <div id="erroNomeParticipante" class="hidden text-red-600 text-xs font-bold mb-1">Preencha o nome.</div>

          <input id="emailParticipante" placeholder="seu.email@zappts.com.br" class="w-full px-4 py-2 border rounded mb-3">
          <div id="erroEmailParticipante" class="hidden text-red-600 text-xs font-bold mb-1">Use um e-mail @zappts.com.br.</div>

          <div class="flex items-start gap-2 mb-3">
            <input type="checkbox" id="aceiteTermoParticipacao" class="mt-1">
            <label class="text-xs text-gray-700 font-semibold">
              Confirmo que assumo o compromisso de presentear a crian√ßa sorteada.
            </label>
          </div>
          <div id="erroTermoParticipante" class="hidden text-red-600 text-xs font-bold mb-3">Aceite o compromisso.</div>

          <div id="erroGeralParticipante" class="hidden text-red-600 text-xs font-bold mb-3"></div>

          <button onclick="app.confirmarParticipacao()" class="w-full bg-cyan-500 text-blue-900 font-bold py-3 rounded-lg">
            Continuar
          </button>

          <button onclick="document.getElementById('modais').innerHTML=''" class="w-full bg-gray-400 text-white font-bold py-2 rounded-lg mt-3">
            Cancelar
          </button>

        </div>
      </div>
    `;
  }

  async confirmarParticipacao() {
    const nome = document.getElementById("nomeParticipante").value.trim();
    const email = document.getElementById("emailParticipante").value.trim();
    const aceite = document.getElementById("aceiteTermoParticipacao").checked;

    const eNome = document.getElementById("erroNomeParticipante");
    const eEmail = document.getElementById("erroEmailParticipante");
    const eTermo = document.getElementById("erroTermoParticipacao");
    const eGeral = document.getElementById("erroGeralParticipante");

    eNome.classList.add("hidden");
    eEmail.classList.add("hidden");
    eTermo.classList.add("hidden");
    eGeral.classList.add("hidden");

    if (!nome) return eNome.classList.remove("hidden");
    if (!this.validarEmail(email)) return eEmail.classList.remove("hidden");
    if (!aceite) return eTermo.classList.remove("hidden");

    const carta = await this.sortearOuRegistrar(email, nome);
    if (!carta) {
      eGeral.textContent = "‚ö†Ô∏è N√£o h√° cartinhas dispon√≠veis.";
      return eGeral.classList.remove("hidden");
    }

    document.getElementById("modais").innerHTML = "";
    this.mostrarResultadoSorteio(carta, nome, email);
  }

  mostrarResultadoSorteio(carta, nome, email) {
    const numero = this.cartas.indexOf(carta) + 1;

    document.getElementById("modais").innerHTML = `
      <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-emerald-400">

          <h2 class="text-2xl font-black text-blue-700 mb-4 text-center">Essa √© a sua crian√ßa üéÅ</h2>

          <div class="bg-gradient-to-br from-emerald-100 to-cyan-100 p-4 rounded-lg mb-6 text-center border-2 border-emerald-400">
            ${
              carta.imagem
                ? `<img src="${carta.imagem}" class="w-24 h-24 rounded-lg mx-auto mb-2">`
                : `<p class="text-5xl mb-2">üòä</p>`
            }
            <p class="font-black text-lg text-blue-900 mb-1">Cartinha #${numero}</p>
            <p class="text-blue-800 font-bold">${carta.nome}, ${carta.idade} anos</p>
            <p class="text-sm text-blue-700 mt-2 font-bold">Desejo: ${carta.desejo}</p>
          </div>

          <button onclick="document.getElementById('modais').innerHTML=''" 
            class="w-full bg-emerald-500 text-white font-bold py-3 rounded-lg">
            Entendi!
          </button>

        </div>
      </div>
    `;
  }

  // ========================= RENDER PRINCIPAL =========================

  renderizar() {
    const minhaCarta = this.minhaCartaId
      ? this.cartas.find(c => c.id === this.minhaCartaId)
      : null;

    document.body.innerHTML = `
      <div id="modais"></div>

      <div class="min-h-screen p-8"
           style="background: linear-gradient(135deg, #0c1e3a, #1a2f5a, #0d1929)">

        <div class="absolute inset-0 pointer-events-none overflow-hidden">
          ${Array.from({length:70}).map(_ => `
            <div class="star absolute rounded-full bg-white"
              style="width:${Math.random()*2}px; height:${Math.random()*2}px;
              left:${Math.random()*100}%; top:${Math.random()*100}%"></div>
          `).join("")}
        </div>

        <div class="relative z-10 max-w-5xl mx-auto">

          <div class="text-center mb-10">
            <div class="flex items-center justify-center gap-6 mb-6">
              <img src="logo-zappts.png" class="h-14">
              <img src="bot-natal.png" class="h-32">
            </div>

            <h1 class="text-5xl md:text-7xl font-black text-white mb-4">
              üéÑ Natal Solid√°rio 2025 üéÑ
            </h1>

            ${
              minhaCarta
                ? `
                  <div class="bg-white bg-opacity-90 p-4 rounded-lg border-2 border-emerald-400 max-w-xl mx-auto mb-6 text-left">
                    <p class="text-xs font-bold text-emerald-700 uppercase mb-1">Sua participa√ß√£o</p>
                    <p class="text-sm font-semibold">Voc√™ recebeu a Cartinha #${this.cartas.indexOf(minhaCarta)+1}</p>
                    <p class="text-sm text-gray-700 font-semibold">${minhaCarta.nome}, ${minhaCarta.idade} anos</p>
                  </div>
                `
                : ""
            }

            <button onclick="app.abrirModalParticipar()"
              class="bg-emerald-400 hover:bg-emerald-300 text-blue-900 font-bold py-3 px-8 rounded-xl text-lg shadow-xl">
              üéÅ Escolher uma crian√ßa
            </button>
          </div>

        </div>
      </div>
    `;

    window.app = this;
  }
}

window.onload = () => new NatalSolidario();
</script>

</body>
</html>
