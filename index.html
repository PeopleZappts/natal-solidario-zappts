<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Natal Solid√°rio Zappts 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes twinkle {

      0%,
      100% {
        opacity: 0.3;
      }

      50% {
        opacity: 1;
      }
    }

    .star {
      animation: twinkle 3s infinite;
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    class NatalSolidario {
      constructor() {
        this.cartas = [];
        this.senhaRelatorio = '@People123';

        // CONTEXTO DO USU√ÅRIO (para mostrar √∫ltimo sorteio na tela)
        this.ultimaEscolha = null;

        // CONFIG SUPABASE
        this.supabaseUrl = 'https://qykyaafhqaatlefozrvq.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5a3lhYWZocWFhdGxlZm96cnZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjEwNzMsImV4cCI6MjA3OTc5NzA3M30.Ik6O0Lm0nsYLkyXAhLQaA7qicTXhLDD4X1Bj_2Fav4Q';
        this.bucket = 'cartinhas';

        this.carregarCartas();
      }

      // ---------- SUPABASE REST ----------
      async db(path, options = {}) {
        const res = await fetch(`${this.supabaseUrl}/rest/v1${path}`, {
          cache: 'no-store', // GARANTE QUE N√ÉO PEGUE DO CACHE
          ...options,
          headers: {
            apikey: this.supabaseKey,
            Authorization: `Bearer ${this.supabaseKey}`,
            ...(options.headers || {})
          }
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error('Erro Supabase DB:', txt);
          throw new Error(txt);
        }

        if (res.status === 204) return null;
        return res.json();
      }

      async uploadImagem(file) {
        const nomeArquivo = `${Date.now()}-${file.name}`;
        const urlUpload = `${this.supabaseUrl}/storage/v1/object/${this.bucket}/${encodeURIComponent(nomeArquivo)}`;

        const res = await fetch(urlUpload, {
          method: 'POST',
          headers: {
            apikey: this.supabaseKey,
            Authorization: `Bearer ${this.supabaseKey}`,
            'Content-Type': file.type
          },
          body: file
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error('Erro upload imagem:', txt);
          throw new Error(txt);
        }

        const publicUrl = `${this.supabaseUrl}/storage/v1/object/public/${this.bucket}/${encodeURIComponent(nomeArquivo)}`;
        return publicUrl;
      }

      // ---------- CARREGAR CARTAS ----------
      async carregarCartas() {
        try {
          // Tabela principal das crian√ßas
          const dados = await this.db('/cartas?select=*');

          this.cartas = (dados || []).map(row => ({
            id: row.id,
            nome: row.nome,
            idade: row.idade,
            desejo: row.desejo,
            imagem: row.imagem,
            numero_cartao: row.numero_cartao || null,
            escolhidosPor: row.escolhidos_por || []
          }));
        } catch (error) {
          console.error('Erro ao carregar cartas:', error);
          this.cartas = [];
        }

        this.renderizar();
      }

      // ---------- VALIDA√á√ïES ----------
      validarEmail(email) {
        return email.endsWith('@zappts.com.br');
      }

      // ---------- ADICIONAR CARTA (admin) ----------
      async adicionarCarta(nome, idade, desejo, numeroCartao, arquivoImagem) {
        try {
          let imagemUrl = null;

          if (arquivoImagem) {
            imagemUrl = await this.uploadImagem(arquivoImagem);
          }

          const corpo = {
            nome: nome.trim(),
            idade: idade.trim(),
            desejo: (desejo || '').trim() || 'Brinquedo a escolher',
            imagem: imagemUrl,
            numero_cartao: numeroCartao ? Number(numeroCartao) : null,
            escolhidos_por: []
          };

          const dados = await this.db('/cartas', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Prefer: 'return=representation'
            },
            body: JSON.stringify(corpo)
          });

          const salva = dados[0];

          this.cartas.push({
            id: salva.id,
            nome: salva.nome,
            idade: salva.idade,
            desejo: salva.desejo,
            imagem: salva.imagem,
            numero_cartao: salva.numero_cartao || null,
            escolhidosPor: salva.escolhidos_por || []
          });

          this.renderizar();
          return true;
        } catch (error) {
          console.error('Erro ao adicionar cartinha:', error);
          alert('Erro ao adicionar cartinha. Veja o console.');
          return false;
        }
      }

      // ---------- SORTEIO DE CRIAN√áA ----------
      abrirModalSorteio() {
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400 max-h-[90vh] overflow-y-auto">
              <h2 class="text-2xl font-black text-blue-700 mb-4">Participar do Natal Solid√°rio üéÅ</h2>

              <p class="text-sm text-gray-700 mb-4 font-semibold">
                Preencha seus dados para receber, por sorteio, a cartinha de uma crian√ßa do Instituto.
              </p>

              <div class="space-y-3 mb-4">
                <input type="text" id="nomeParticipante" placeholder="Seu nome completo"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold">
                <input type="email" id="emailParticipante" placeholder="seu.email@zappts.com.br"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold">
              </div>

              <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-3 text-xs font-semibold text-yellow-900 mb-3">
                <p>
                  Ao confirmar, voc√™ est√° assumindo um compromisso com essa crian√ßa:
                  comprar e enviar o presente dentro do prazo combinado.
                  Ela est√° esperando por voc√™. üíõ
                </p>
              </div>

              <div class="flex items-start gap-2 mb-3">
                <input type="checkbox" id="aceiteTermo" class="mt-1">
                <label for="aceiteTermo" class="text-xs text-gray-700 font-semibold">
                  Li e estou ciente de que estou assumindo um compromisso de presentear esta crian√ßa dentro do prazo informado.
                </label>
              </div>

              <div id="erroSorteio" class="text-red-600 text-xs font-bold mb-3 hidden"></div>

              <div class="flex gap-3 mt-4">
                <button onclick="document.getElementById('modais').innerHTML = ''"
                  class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">
                  Cancelar
                </button>
                <button id="btnConfirmarSorteio" onclick="app.confirmarSorteio()"
                  class="flex-1 px-4 py-2 bg-emerald-400 text-blue-900 font-bold rounded-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                  Sortear crian√ßa üéÅ
                </button>
              </div>
            </div>
          </div>
        `;
      }

      async confirmarSorteio() {
        const nome = document.getElementById('nomeParticipante').value.trim();
        const email = document.getElementById('emailParticipante').value.trim();
        const aceite = document.getElementById('aceiteTermo').checked;
        const erroDiv = document.getElementById('erroSorteio');

        erroDiv.classList.add('hidden');
        erroDiv.textContent = '';

        if (!nome) {
          erroDiv.textContent = 'Informe seu nome.';
          erroDiv.classList.remove('hidden');
          return;
        }

        if (!this.validarEmail(email)) {
          erroDiv.textContent = 'Email deve terminar com @zappts.com.br.';
          erroDiv.classList.remove('hidden');
          return;
        }

        if (!aceite) {
          erroDiv.textContent = 'Voc√™ precisa aceitar o compromisso antes de continuar.';
          erroDiv.classList.remove('hidden');
          return;
        }

        if (!this.cartas.length) {
          erroDiv.textContent = 'Nenhuma cartinha dispon√≠vel para sorteio.';
          erroDiv.classList.remove('hidden');
          return;
        }

        // Verifica se o email j√° participou
        const jaParticipou = this.cartas.some(c => (c.escolhidosPor || []).includes(email));
        if (jaParticipou) {
          erroDiv.textContent = 'Este email j√° escolheu uma cartinha! Se precisar trocar, fale com People.';
          erroDiv.classList.remove('hidden');
          return;
        }

        // Cartas "dispon√≠veis" para o sorteio na interface (sem ningu√©m no array escolhidosPor)
        const disponiveis = this.cartas.filter(c => (c.escolhidosPor || []).length === 0);

        if (!disponiveis.length) {
          erroDiv.textContent = 'Todas as cartinhas j√° foram sorteadas na interface. Fale com People.';
          erroDiv.classList.remove('hidden');
          return;
        }

        // Feedback visual de carregamento
        const btnConfirmar = document.getElementById('btnConfirmarSorteio');
        const textoOriginal = btnConfirmar.innerText;
        btnConfirmar.disabled = true;
        btnConfirmar.innerText = 'Sorteando... ‚è≥';

        try {
          // Sorteia uma crian√ßa aleat√≥ria
          const sorteada = disponiveis[Math.floor(Math.random() * disponiveis.length)];

          // Prepara o novo array de escolhidos
          const novosEscolhidos = [...(sorteada.escolhidosPor || []), email];

          // 1. Atualiza no Supabase
          const retornoSupabase = await this.db(`/cartas?id=eq.${sorteada.id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              Prefer: 'return=representation'
            },
            body: JSON.stringify({
              escolhidos_por: novosEscolhidos
            })
          });

          // Verifica se realmente salvou (se RLS bloquear, pode retornar vazio)
          if (Array.isArray(retornoSupabase) && retornoSupabase.length === 0) {
            throw new Error('Permiss√£o negada pelo banco de dados (RLS). A escolha n√£o foi salva.');
          }

          // 2. Atualiza em mem√≥ria
          sorteada.escolhidosPor = novosEscolhidos;

          // Guarda contexto do √∫ltimo sorteio
          this.ultimaEscolha = {
            participanteNome: nome,
            participanteEmail: email,
            carta: sorteada
          };

          // 3. Dispara webhook para o n8n / backend
          // N√£o vamos esperar o webhook para n√£o travar a UI se der erro nele
          this.enviarWebhook(nome, email, sorteada);

          // Fecha modal e re-render
          document.getElementById('modais').innerHTML = '';
          this.renderizar();

        } catch (error) {
          console.error('Erro ao salvar sorteio:', error);
          // MOSTRA O ERRO REAL NA TELA PARA DEBUG
          erroDiv.textContent = `Erro ao salvar: ${error.message || error}. Tente novamente ou fale com o admin.`;
          erroDiv.classList.remove('hidden');
          btnConfirmar.disabled = false;
          btnConfirmar.innerText = textoOriginal;
        }
      }

      async enviarWebhook(nome, email, carta) {
        const payload = {
          participante_nome: nome,
          participante_email: email,
          cartinha_id: carta.id,
          numero_cartao: carta.numero_cartao,
          crianca_nome: carta.nome,
          crianca_idade: carta.idade,
          desejo: carta.desejo
        };

        try {
          // Usa o proxy do Vercel para evitar erro de CORS
          await fetch('/api/webhook', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          console.log('Webhook enviado com sucesso', payload);
        } catch (error) {
          console.error('Erro ao enviar webhook:', error);
        }
      }

      // ---------- DELETAR CARTA (admin) ----------
      deletarCarta(cartaId) {
        this.cartaIdParaDeletar = cartaId;
        this.abrirModalSenhaDelete();
      }

      async confirmarDelete() {
        const senha = document.getElementById('senhaDelete').value;
        const erroDiv = document.getElementById('erroSenhaDelete');

        if (senha !== this.senhaRelatorio) {
          erroDiv.classList.remove('hidden');
          return;
        }

        try {
          await this.db(`/cartas?id=eq.${this.cartaIdParaDeletar}`, {
            method: 'DELETE'
          });

          this.cartas = this.cartas.filter(c => c.id !== this.cartaIdParaDeletar);
          document.getElementById('modais').innerHTML = '';
          this.renderizar();
        } catch (error) {
          console.error('Erro ao deletar cartinha:', error);
          alert('Erro ao excluir cartinha. Veja o console.');
        }
      }

      // ---------- RELAT√ìRIO (a partir do estado atual das cartas) ----------
      baixarRelatorio(senha) {
        if (senha !== this.senhaRelatorio) return false;

        let conteudo = 'N¬∫ Cartinha,Nome,Idade,Desejo,Zappters que Escolheram,Total de Escolhas\n';

        this.cartas.forEach((carta, index) => {
          const emails = (carta.escolhidosPor || []).join('; ');
          const total = (carta.escolhidosPor || []).length;
          conteudo += `${index + 1},"${carta.nome}",${carta.idade},"${carta.desejo}","${emails}",${total}\n`;
        });

        const blob = new Blob([conteudo], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        link.setAttribute('href', url);
        link.setAttribute('download', `natal-solidario-relatorio-${new Date().toLocaleDateString()}.csv`);
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        return true;
      }

      // ---------- RENDER ----------
      renderizar() {
        const app = document.getElementById('app');

        const totalCartas = this.cartas.length;
        const totalEscolhas = this.cartas.reduce(
          (s, c) => s + (c.escolhidosPor ? c.escolhidosPor.length : 0),
          0
        );

        const ultimo = this.ultimaEscolha;

        app.innerHTML = `
          <div class="min-h-screen p-8" style="background: linear-gradient(135deg, #0c1e3a 0%, #1a2f5a 50%, #0d1929 100%); background-attachment: fixed;">
            <!-- Estrelas -->
            <div class="absolute inset-0 pointer-events-none overflow-hidden">
              ${Array.from({ length: 100 }, () => `
                <div class="star absolute rounded-full bg-white" style="
                  width: ${Math.random() * 2}px;
                  height: ${Math.random() * 2}px;
                  left: ${Math.random() * 100}%;
                  top: ${Math.random() * 100}%;
                  opacity: 0.7;
                "></div>
              `).join('')}
            </div>

            <div class="max-w-7xl mx-auto relative z-10 flex flex-col min-h-screen">
              <!-- Cabe√ßalho -->
              <div class="text-center mb-10">
                <div class="flex items-center justify-center gap-6 mb-6">
                  <img src="logo-zappts.png" alt="Zappts" class="h-14 md:h-16 object-contain" />
                  <img src="bot-natal.png" class="h-32 md:h-40 object-contain" />
                </div>
                <h1 class="text-5xl md:text-7xl font-black text-white mb-4 drop-shadow-2xl" style="font-family: Arial, sans-serif; letter-spacing: 0.02em;">
                  üéÑ Natal Solid√°rio 2025 üéÑ
                </h1>
                <p class="text-2xl md:text-3xl text-white mb-6 font-black drop-shadow-lg" style="font-family: Arial, sans-serif;">
                  Escolha uma cartinha e realize um sonho de Natal!
                </p>

                <div class="inline-block bg-cyan-500 bg-opacity-30 backdrop-blur px-8 py-4 rounded-xl border-2 border-cyan-400 mb-6">
                  <p class="text-white font-bold text-lg">
                    ‚ú® ${totalCartas} cartinhas cadastradas ‚Ä¢ ${totalEscolhas} escolhas registradas na interface
                  </p>
                </div>

                <!-- V√≠deo do Instituto (YouTube n√£o listado) -->
                <div class="max-w-3xl mx-auto mb-6">
                  <div class="relative w-full overflow-hidden rounded-2xl shadow-2xl border-2 border-cyan-400">
                    <div class="w-full aspect-video bg-black">
                      <iframe
                        class="w-full h-full"
                        src="https://www.youtube.com/embed/PqN0BUKWg8U"
                        title="V√≠deo Instituto Eden Lar"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                      </iframe>
                    </div>
                  </div>
                </div>

                ${ultimo
            ? `
                      <div class="max-w-xl mx-auto bg-white bg-opacity-95 rounded-xl p-4 border-2 border-emerald-400 mb-4 text-left">
                        <p class="text-xs font-bold text-emerald-700 mb-1 uppercase tracking-wide">Sua crian√ßa sorteada</p>
                        <p class="text-sm font-semibold text-gray-800 mb-2">
                          ${ultimo.participanteNome}, voc√™ recebeu a
                          <span class="font-black text-blue-700">
                            Cartinha #${this.cartas.indexOf(ultimo.carta) + 1}
                            ${ultimo.carta.numero_cartao ? `(c√≥digo ${ultimo.carta.numero_cartao})` : ''}
                          </span>.
                        </p>
                        <p class="text-sm text-gray-700"><span class="font-bold">Crian√ßa:</span> ${ultimo.carta.nome}, ${ultimo.carta.idade} anos</p>
                        <p class="text-sm text-gray-700"><span class="font-bold">Desejo:</span> ${ultimo.carta.desejo}</p>
                        <p class="text-xs text-gray-500 mt-2">As orienta√ß√µes completas v√£o chegar pelos canais internos de People.</p>
                      </div>
                    `
            : ''
          }

                <!-- Bot√µes principais -->
                <div class="flex justify-center mb-4 gap-4 flex-wrap">
                  <button onclick="app.abrirModalSorteio()"
                    class="bg-emerald-400 hover:bg-emerald-300 text-blue-900 font-bold py-3 px-8 rounded-xl flex items-center gap-2 transition shadow-xl text-lg">
                    üéÅ Escolher Cartinha
                  </button>

                  <button onclick="app.abrirModalInfo()"
                    class="bg-white hover:bg-gray-100 text-blue-700 font-bold py-3 px-8 rounded-xl flex items-center gap-2 transition shadow-xl text-lg">
                    ‚ÑπÔ∏è Saiba Mais
                  </button>
                </div>
              </div>

              <!-- Grid de Cartas (somente visual) -->
              <div class="flex-1">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-12">
                  ${this.cartas.length > 0
            ? this.cartas.map((c, i) => `
                        <div class="relative rounded-xl overflow-hidden shadow-xl hover:shadow-2xl transition">
                          <div class="p-4 rounded-xl bg-gradient-to-br from-emerald-300 to-emerald-400 h-64 flex flex-col justify-between">
                            <div class="flex justify-between items-start">
                              <div class="flex flex-col gap-1">
                                <span class="inline-block bg-blue-700 text-white px-2 py-1 rounded-full text-xs font-black">
                                  #${i + 1}${c.numero_cartao ? ` ‚Ä¢ c√≥digo ${c.numero_cartao}` : ''}
                                </span>
                              </div>
                                <button onclick="event.stopPropagation(); app.editarCarta(${c.id})"
                                  class="text-blue-800 hover:text-blue-950 bg-white rounded-full p-1 shadow-lg text-xs mr-2">
                                  ‚úèÔ∏è
                                </button>
                                <button onclick="event.stopPropagation(); app.deletarCarta(${c.id})"
                                  class="text-blue-800 hover:text-blue-950 bg-white rounded-full p-1 shadow-lg text-xs">
                                  ‚úï
                                </button>
                            </div>
                            <div class="text-center flex-1 flex items-center justify-center">
                              ${c.imagem
                ? `<img src="${c.imagem}" class="w-20 h-20 object-cover rounded-lg cursor-pointer" onclick="event.stopPropagation(); app.ampliarImagem('${c.imagem}')">`
                : '<p class="text-5xl">üòä</p>'
              }
                            </div>
                            <div class="text-center">
                              <p class="font-black text-blue-900 text-sm">${c.nome}</p>
                              <p class="text-xs text-blue-800 font-semibold">${c.idade} anos</p>
                              <p class="text-xs text-blue-700 mt-1 italic font-semibold">${c.desejo}</p>
                            </div>
                            <div class="text-center mt-1">
                              <p class="text-[11px] font-black bg-blue-700 text-white py-1 px-2 rounded-lg">
                                üë• ${(c.escolhidosPor || []).length} ${(c.escolhidosPor || []).length === 1 ? 'escolha' : 'escolhas'} registradas nesta tela
                              </p>
                            </div>
                          </div>
                        </div>
                      `).join('')
            : '<div class="col-span-full text-center py-20 text-white text-2xl font-bold">Nenhuma cartinha adicionada ainda! üéÑ</div>'
          }
                </div>
              </div>

              <!-- A√ß√µes administrativas discretas -->
              <div class="mt-4 flex justify-end gap-6 pr-4 text-sm opacity-70 hover:opacity-100 transition-all">
                <button 
                  onclick="app.abrirModalSenhaAdmin('importar')" 
                  class="text-cyan-300 hover:text-cyan-100 font-semibold flex items-center gap-1">
                    üìÇ Importar CSV
                </button>

                <button 
                  onclick="app.abrirModalSenhaAdmin('adicionar')" 
                  class="text-cyan-300 hover:text-cyan-100 font-semibold flex items-center gap-1">
                    ‚ûï Adicionar cartinha
                </button>

                <button 
                  onclick="app.abrirModalSenha()" 
                  class="text-green-300 hover:text-green-100 font-semibold flex items-center gap-1">
                    üìÑ Baixar relat√≥rio
                </button>
              </div>
            </div>

            <!-- Modais -->
            <div id="modais"></div>
          </div>
        `;

        window.app = this;
      }

      // ---------- EDITAR CARTA (admin) ----------
      editarCarta(cartaId) {
        this.cartaEmEdicao = this.cartas.find(c => c.id === cartaId);
        if (!this.cartaEmEdicao) return;
        this.abrirModalSenhaAdmin('editar');
      }

      abrirModalEditarCarta() {
        const c = this.cartaEmEdicao;
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">
              <h2 class="text-2xl font-black text-blue-700 mb-4">‚úèÔ∏è Editar Cartinha</h2>
              <div class="space-y-4 mb-6">
                <input type="text" id="editNome" value="${c.nome}" placeholder="Nome"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg font-semibold">
                <input type="text" id="editIdade" value="${c.idade}" placeholder="Idade"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg font-semibold">
                <input type="text" id="editNumero" value="${c.numero_cartao || ''}" placeholder="C√≥digo"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg font-semibold">
                <input type="text" id="editDesejo" value="${c.desejo}" placeholder="Desejo"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg font-semibold">
                
                <div class="text-xs text-gray-500">Imagem atual: ${c.imagem ? 'Sim' : 'N√£o'}</div>
                <input type="file" id="editImagem" accept="image/*" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg">
              </div>
              <div class="flex gap-3">
                <button onclick="document.getElementById('modais').innerHTML = ''"
                  class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">
                  Cancelar
                </button>
                <button onclick="app.confirmarEdicao()"
                  class="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg text-lg">
                  Salvar
                </button>
              </div>
            </div>
          </div>
        `;
      }

      async confirmarEdicao() {
        const nome = document.getElementById('editNome').value;
        const idade = document.getElementById('editIdade').value;
        const numero = document.getElementById('editNumero').value;
        const desejo = document.getElementById('editDesejo').value;
        const imagemInput = document.getElementById('editImagem');

        let imagemUrl = this.cartaEmEdicao.imagem;

        if (imagemInput.files && imagemInput.files[0]) {
          imagemUrl = await this.uploadImagem(imagemInput.files[0]);
        }

        try {
          await this.db(`/cartas?id=eq.${this.cartaEmEdicao.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              nome,
              idade,
              numero_cartao: numero ? Number(numero) : null,
              desejo,
              imagem: imagemUrl
            })
          });

          // Atualiza local
          this.cartaEmEdicao.nome = nome;
          this.cartaEmEdicao.idade = idade;
          this.cartaEmEdicao.numero_cartao = numero;
          this.cartaEmEdicao.desejo = desejo;
          this.cartaEmEdicao.imagem = imagemUrl;

          document.getElementById('modais').innerHTML = '';
          this.renderizar();
        } catch (error) {
          console.error('Erro ao editar:', error);
          alert('Erro ao salvar edi√ß√£o.');
        }
      }

      // ---------- MODAIS AUXILIARES ----------
      abrirModalSenhaAdmin(acao = 'adicionar') {
        this.acaoAdmin = acao;
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">
              <h2 class="text-2xl font-black text-blue-700 mb-4">üîí Acesso para adicionar cartinha</h2>
              <p class="text-gray-700 mb-6 font-semibold">Digite a senha de People:</p>
              <input type="password" id="senhaAdmin" placeholder="Digite a senha"
                class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold mb-4">
              <div id="erroSenhaAdmin" class="text-red-600 text-sm font-bold mb-4 hidden">‚ö†Ô∏è Senha incorreta!</div>
              <div class="flex gap-3">
                <button onclick="document.getElementById('modais').innerHTML = ''"
                  class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">
                  Cancelar
                </button>
                <button onclick="app.confirmarSenhaAdmin()"
                  class="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg text-lg">
                  Confirmar
                </button>
              </div>
            </div>
          </div>
        `;
      }

      confirmarSenhaAdmin() {
        const senha = document.getElementById('senhaAdmin').value;
        const erroDiv = document.getElementById('erroSenhaAdmin');

        if (senha !== this.senhaRelatorio) {
          erroDiv.classList.remove('hidden');
          return;
        }

        document.getElementById('modais').innerHTML = '';

        if (this.acaoAdmin === 'importar') {
          this.abrirModalImportarCSV();
        } else if (this.acaoAdmin === 'editar') {
          this.abrirModalEditarCarta();
        } else {
          this.abrirModalNovaCarta();
        }
      }

      abrirModalImportarCSV() {
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">
              <h2 class="text-2xl font-black text-blue-700 mb-4">üìÇ Importar CSV</h2>
              <p class="text-sm text-gray-600 mb-4">
                O arquivo deve ter as colunas: <strong>COD, IDADE, GENERO</strong>.
              </p>
              <input type="file" id="arquivoCSV" accept=".csv" class="w-full border-2 border-cyan-300 rounded-lg p-2 mb-4">
              
              <div class="flex gap-3">
                <button onclick="document.getElementById('modais').innerHTML = ''"
                  class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">
                  Cancelar
                </button>
                <button onclick="app.confirmarImportacaoCSV()"
                  class="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg text-lg">
                  Importar
                </button>
              </div>
            </div>
          </div>
        `;
      }

      async confirmarImportacaoCSV() {
        const input = document.getElementById('arquivoCSV');
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const text = await file.text();

        // Parse CSV mais robusto
        const linhas = text.split(/\r?\n/); // Lida com quebra de linha Windows/Unix

        // Tenta detectar separador (v√≠rgula ou ponto e v√≠rgula)
        const primeiraLinha = linhas[0];
        const separador = primeiraLinha.includes(';') ? ';' : ',';

        const cabecalho = primeiraLinha.split(separador).map(c => c.trim().toUpperCase().replace(/^[\uFEFF]/, '')); // Remove BOM e espa√ßos

        const idxCod = cabecalho.indexOf('COD');
        const idxIdade = cabecalho.indexOf('IDADE');
        const idxGenero = cabecalho.indexOf('GENERO');

        if (idxCod === -1 || idxIdade === -1 || idxGenero === -1) {
          alert('CSV inv√°lido! Verifique as colunas: COD, IDADE, GENERO');
          return;
        }

        let sucesso = 0;

        for (let i = 1; i < linhas.length; i++) {
          const linha = linhas[i].trim();
          if (!linha) continue;

          // Lida com CSV que pode ter virgulas dentro de aspas (simplificado)
          // Lida com CSV que pode ter virgulas dentro de aspas (simplificado)
          const colunas = linha.split(separador);

          const cod = colunas[idxCod]?.trim();
          const idade = colunas[idxIdade]?.trim();
          const genero = colunas[idxGenero]?.trim();

          if (cod && idade && genero) {
            // Usa Genero como Nome provis√≥rio
            await this.adicionarCarta(genero, idade, 'Brinquedo a escolher', cod, null);
            sucesso++;
          }
        }

        alert(`${sucesso} cartinhas importadas com sucesso!`);
        document.getElementById('modais').innerHTML = '';
      }

      abrirModalNovaCarta() {
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">
              <h2 class="text-2xl font-black text-blue-700 mb-4">Adicionar Nova Cartinha üéÅ</h2>
              <div class="space-y-4 mb-6">
                <input type="text" id="nomeCarta" placeholder="Nome da crian√ßa"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold">
                <input type="text" id="idadeCarta" placeholder="Idade"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold">
                <input type="text" id="numeroCarta" placeholder="N√∫mero da cartinha (c√≥digo do cart√£o f√≠sico)"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold">
                <input type="text" id="desejoCarta" placeholder="O que deseja (opcional)"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold">
                <input type="file" id="imagemCarta" accept="image/*"
                  class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg">
              </div>
              <div class="flex gap-3">
                <button onclick="document.getElementById('modais').innerHTML = ''"
                  class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">
                  Cancelar
                </button>
                <button onclick="app.confirmarNovaCarta()"
                  class="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg text-lg">
                  Adicionar
                </button>
              </div>
            </div>
          </div>
        `;
      }

      async confirmarNovaCarta() {
        const nome = document.getElementById('nomeCarta').value;
        const idade = document.getElementById('idadeCarta').value;
        const numeroCartao = document.getElementById('numeroCarta').value;
        const desejo = document.getElementById('desejoCarta').value;
        const imagemInput = document.getElementById('imagemCarta');
        const arquivo = imagemInput.files[0] || null;

        if (!nome.trim() || !idade.trim()) {
          alert('Preencha nome e idade!');
          return;
        }

        await this.adicionarCarta(nome, idade, desejo, numeroCartao, arquivo);
        document.getElementById('modais').innerHTML = '';
      }

      abrirModalInfo() {
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-2xl w-full shadow-2xl border-2 border-cyan-400 max-h-96 overflow-y-auto">
              <h2 class="text-2xl font-black text-blue-700 mb-4">üìã Regras e Prazos</h2>
              <div class="space-y-4 text-gray-800 text-sm md:text-base">
                <div>
                  <h3 class="font-black text-blue-700 mb-2 text-lg">üéÖ‚ú® Natal Solid√°rio - Zappts 2025 ‚ú®</h3>
                  <p class="font-semibold">
                    Promover integra√ß√£o entre os Zappters e impactar positivamente a comunidade por meio de uma a√ß√£o solid√°ria,
                    incentivando a doa√ß√£o de brinquedos para crian√ßas em situa√ß√£o de vulnerabilidade social,
                    com apoio financeiro da Zappts.
                  </p>
                </div>
                <div>
                  <h3 class="font-black text-blue-700 mb-2 text-lg">1. Descri√ß√£o da A√ß√£o</h3>
                  <p class="font-semibold">
                    A campanha visa engajar nossos colaboradores na doa√ß√£o de brinquedos para crian√ßas em situa√ß√£o de vulnerabilidade,
                    com foco no Instituto Eden Lar - S√£o Jos√© dos Campos, em parceria com o PIT - Parque de Inova√ß√£o Tecnol√≥gica.
                    Cada participante receber√° um voucher de R$ 50 como saldo livre no Caju, para compra do brinquedo.
                  </p>
                </div>
                <div>
                  <h3 class="font-black text-blue-700 mb-2 text-lg">2. Como funcionar√°?</h3>
                  <ul class="space-y-1 ml-4 font-semibold list-disc">
                    <li>Inscri√ß√µes at√© 02/12/2025, via formul√°rio interno.</li>
                    <li>Cada participante recebe um voucher de R$ 50 no saldo livre do Caju.</li>
                    <li>O brinquedo deve ser comprado online e enviado para o endere√ßo do PIT.</li>
                    <li>As crian√ßas s√£o sorteadas aqui na p√°gina, conforme as cartinhas cadastradas.</li>
                  </ul>
                </div>
                <div>
                  <h3 class="font-black text-blue-700 mb-2 text-lg">3. Prazos</h3>
                  <ul class="space-y-1 ml-4 font-semibold list-disc">
                    <li>Abertura das inscri√ß√µes: 27/11/2025</li>
                    <li>Prazo final para inscri√ß√£o: 02/12/2025</li>
                    <li>Distribui√ß√£o dos vouchers: 04/12/2025</li>
                    <li>Prazo de entrega dos brinquedos: 08/12/2025</li>
                    <li>Entrega dos brinquedos ao Instituto Eden Lar: 11/12/2025</li>
                  </ul>
                </div>
                <div>
                  <h3 class="font-black text-blue-700 mb-2 text-lg">4. Compartilhamento</h3>
                  <p class="font-semibold">
                    Ap√≥s a compra, o Zappter participante deve postar no canal Espa√ßo Zappts, no Google Chat:
                  </p>
                  <ul class="space-y-1 ml-4 font-semibold list-disc">
                    <li>Imagem do brinquedo comprado.</li>
                    <li>Caracter√≠sticas da crian√ßa (quando dispon√≠veis) e brinquedo escolhido.</li>
                  </ul>
                </div>
              </div>
              <button onclick="document.getElementById('modais').innerHTML = ''"
                class="w-full mt-6 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg text-lg">
                Entendi!
              </button>
            </div>
          </div>
        `;
      }

      abrirModalSenha() {
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">
              <h2 class="text-2xl font-black text-blue-700 mb-4">üîí Acesso ao Relat√≥rio</h2>
              <p class="text-gray-700 mb-6 font-semibold">Digite a senha:</p>
              <input type="password" id="senhaInput" placeholder="Digite a senha"
                class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold mb-4">
              <div id="erroSenha" class="text-red-600 text-sm font-bold mb-4 hidden">‚ö†Ô∏è Senha incorreta!</div>
              <div class="flex gap-3">
                <button onclick="document.getElementById('modais').innerHTML = ''"
                  class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">
                  Cancelar
                </button>
                <button onclick="app.confirmarSenha()"
                  class="flex-1 px-4 py-2 bg-green-600 text-white font-bold rounded-lg text-lg">
                  Baixar
                </button>
              </div>
            </div>
          </div>
        `;
      }

      confirmarSenha() {
        const senha = document.getElementById('senhaInput').value;
        const erroDiv = document.getElementById('erroSenha');

        if (this.baixarRelatorio(senha)) {
          document.getElementById('modais').innerHTML = '';
        } else {
          erroDiv.classList.remove('hidden');
        }
      }

      abrirModalSenhaDelete() {
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-2 border-cyan-400">
              <h2 class="text-2xl font-black text-blue-700 mb-4">üîí Excluir Cartinha</h2>
              <p class="text-gray-700 mb-6 font-semibold">Digite a senha para excluir:</p>
              <input type="password" id="senhaDelete" placeholder="Digite a senha"
                class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-600 font-semibold mb-4">
              <div id="erroSenhaDelete" class="text-red-600 text-sm font-bold mb-4 hidden">‚ö†Ô∏è Senha incorreta!</div>
              <div class="flex gap-3">
                <button onclick="document.getElementById('modais').innerHTML = ''"
                  class="flex-1 px-4 py-2 bg-gray-400 text-white font-bold rounded-lg text-lg">
                  Cancelar
                </button>
                <button onclick="app.confirmarDelete()"
                  class="flex-1 px-4 py-2 bg-red-600 text-white font-bold rounded-lg text-lg">
                  Excluir
                </button>
              </div>
            </div>
          </div>
        `;
      }

      ampliarImagem(src) {
        if (!src) return;
        const modaisDiv = document.getElementById('modais');
        modaisDiv.innerHTML = `
          <div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
            <div class="relative">
              <button onclick="document.getElementById('modais').innerHTML = ''"
                class="absolute -top-12 right-0 text-white hover:text-gray-300 text-3xl">
                ‚úï
              </button>
              <img src="${src}" class="rounded-xl shadow-2xl max-w-full max-h-96 object-contain">
            </div>
          </div>
        `;
      }
    }

    // Inicializa quando a p√°gina carrega
    window.addEventListener('load', () => {
      new NatalSolidario();
    });
  </script>
</body>

</html>
